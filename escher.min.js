/**
 * almond 0.2.6 Copyright (c) 2011-2012, The Dojo Foundation All Rights Reserved.
 * Available via the MIT or new BSD license.
 * see: http://github.com/jrburke/almond for details
 */

/**
 * vkBeautify - javascript plugin to pretty-print or minify text in XML, JSON, CSS and SQL formats.
 *
 * Version - 0.99.00.beta
 * Copyright (c) 2012 Vadim Kiryukhin
 * vkiryukhin @ gmail.com
 * http://www.eslinstructor.net/vkbeautify/
 *
 * Dual licensed under the MIT and GPL licenses:
 *   http://www.opensource.org/licenses/mit-license.php
 *   http://www.gnu.org/licenses/gpl.html
 *
 *   Pretty print
 *
 *        vkbeautify.xml(text [,indent_pattern]);
 *        vkbeautify.json(text [,indent_pattern]);
 *        vkbeautify.css(text [,indent_pattern]);
 *        vkbeautify.sql(text [,indent_pattern]);
 *
 *        @text - String; text to beatufy;
 *        @indent_pattern - Integer | String;
 *                Integer:  number of white spaces;
 *                String:   character string to visualize indentation ( can also be a set of white spaces )
 *   Minify
 *
 *        vkbeautify.xmlmin(text [,preserve_comments]);
 *        vkbeautify.jsonmin(text);
 *        vkbeautify.cssmin(text [,preserve_comments]);
 *        vkbeautify.sqlmin(text);
 *
 *        @text - String; text to minify;
 *        @preserve_comments - Bool; [optional];
 *                Set this flag to true to prevent removing comments from @text ( minxml and mincss functions only. )
 *
 *   Examples:
 *        vkbeautify.xml(text); // pretty print XML
 *        vkbeautify.json(text, 4 ); // pretty print JSON
 *        vkbeautify.css(text, '. . . .'); // pretty print CSS
 *        vkbeautify.sql(text, '----'); // pretty print SQL
 *
 *        vkbeautify.xmlmin(text, true);// minify XML, preserve comments
 *        vkbeautify.jsonmin(text);// minify JSON
 *        vkbeautify.cssmin(text);// minify CSS, remove comments ( default )
 *        vkbeautify.sqlmin(text);// minify SQL
 *
 */

/**
 * complete.ly 1.0.0
 * MIT Licensing
 * Copyright (c) 2013 Lorenzo Puccetti
 * 
 * This Software shall be used for doing good things, not bad things.
 * 
**/

(function(e,t){typeof define=="function"&&define.amd?define(escher,t):e.escher=t()})(this,function(){var e,t,n;return function(r){function d(e,t){return h.call(e,t)}function v(e,t){var n,r,i,s,o,u,a,f,c,h,p=t&&t.split("/"),d=l.map,v=d&&d["*"]||{};if(e&&e.charAt(0)===".")if(t){p=p.slice(0,p.length-1),e=p.concat(e.split("/"));for(f=0;f<e.length;f+=1){h=e[f];if(h===".")e.splice(f,1),f-=1;else if(h===".."){if(f===1&&(e[2]===".."||e[0]===".."))break;f>0&&(e.splice(f-1,2),f-=2)}}e=e.join("/")}else e.indexOf("./")===0&&(e=e.substring(2));if((p||v)&&d){n=e.split("/");for(f=n.length;f>0;f-=1){r=n.slice(0,f).join("/");if(p)for(c=p.length;c>0;c-=1){i=d[p.slice(0,c).join("/")];if(i){i=i[r];if(i){s=i,o=f;break}}}if(s)break;!u&&v&&v[r]&&(u=v[r],a=f)}!s&&u&&(s=u,o=a),s&&(n.splice(0,o,s),e=n.join("/"))}return e}function m(e,t){return function(){return s.apply(r,p.call(arguments,0).concat([e,t]))}}function g(e){return function(t){return v(t,e)}}function y(e){return function(t){a[e]=t}}function b(e){if(d(f,e)){var t=f[e];delete f[e],c[e]=!0,i.apply(r,t)}if(!d(a,e)&&!d(c,e))throw new Error("No "+e);return a[e]}function w(e){var t,n=e?e.indexOf("!"):-1;return n>-1&&(t=e.substring(0,n),e=e.substring(n+1,e.length)),[t,e]}function E(e){return function(){return l&&l.config&&l.config[e]||{}}}var i,s,o,u,a={},f={},l={},c={},h=Object.prototype.hasOwnProperty,p=[].slice;o=function(e,t){var n,r=w(e),i=r[0];return e=r[1],i&&(i=v(i,t),n=b(i)),i?n&&n.normalize?e=n.normalize(e,g(t)):e=v(e,t):(e=v(e,t),r=w(e),i=r[0],e=r[1],i&&(n=b(i))),{f:i?i+"!"+e:e,n:e,pr:i,p:n}},u={require:function(e){return m(e)},exports:function(e){var t=a[e];return typeof t!="undefined"?t:a[e]={}},module:function(e){return{id:e,uri:"",exports:a[e],config:E(e)}}},i=function(e,t,n,i){var s,l,h,p,v,g=[],w;i=i||e;if(typeof n=="function"){t=!t.length&&n.length?["require","exports","module"]:t;for(v=0;v<t.length;v+=1){p=o(t[v],i),l=p.f;if(l==="require")g[v]=u.require(e);else if(l==="exports")g[v]=u.exports(e),w=!0;else if(l==="module")s=g[v]=u.module(e);else if(d(a,l)||d(f,l)||d(c,l))g[v]=b(l);else{if(!p.p)throw new Error(e+" missing "+l);p.p.load(p.n,m(i,!0),y(l),{}),g[v]=a[l]}}h=n.apply(a[e],g);if(e)if(s&&s.exports!==r&&s.exports!==a[e])a[e]=s.exports;else if(h!==r||!w)a[e]=h}else e&&(a[e]=n)},e=t=s=function(e,t,n,a,f){return typeof e=="string"?u[e]?u[e](t):b(o(e,t).f):(e.splice||(l=e,t.splice?(e=t,t=n,n=null):e=r),t=t||function(){},typeof n=="function"&&(n=a,a=f),a?i(r,e,t,n):setTimeout(function(){i(r,e,t,n)},4),s)},s.config=function(e){return l=e,l.deps&&s(l.deps,l.callback),s},e._defined=a,n=function(e,t,n){t.splice||(n=t,t=[]),!d(a,e)&&!d(f,e)&&(f[e]=[e,t,n])},n.amd={jQuery:!0}}(),n("almond",function(){}),n("lib/d3",[],function(){return window.d3===undefined&&console.error("d3 is not loaded."),window.d3}),n("lib/vkbeautify",[],function(){function e(e){var t="    ";if(isNaN(parseInt(e)))t=e;else switch(e){case 1:t=" ";break;case 2:t="  ";break;case 3:t="   ";break;case 4:t="    ";break;case 5:t="     ";break;case 6:t="      ";break;case 7:t="       ";break;case 8:t="        ";break;case 9:t="         ";break;case 10:t="          ";break;case 11:t="           ";break;case 12:t="            "}var n=["\n"];for(ix=0;ix<100;ix++)n.push(n[ix]+t);return n}function t(){this.step="    ",this.shift=e(this.step)}function n(e,t){return t-(e.replace(/\(/g,"").length-e.replace(/\)/g,"").length)}function r(e,t){return e.replace(/\s{1,}/g," ").replace(/ AND /ig,"~::~"+t+t+"AND ").replace(/ BETWEEN /ig,"~::~"+t+"BETWEEN ").replace(/ CASE /ig,"~::~"+t+"CASE ").replace(/ ELSE /ig,"~::~"+t+"ELSE ").replace(/ END /ig,"~::~"+t+"END ").replace(/ FROM /ig,"~::~FROM ").replace(/ GROUP\s{1,}BY/ig,"~::~GROUP BY ").replace(/ HAVING /ig,"~::~HAVING ").replace(/ IN /ig," IN ").replace(/ JOIN /ig,"~::~JOIN ").replace(/ CROSS~::~{1,}JOIN /ig,"~::~CROSS JOIN ").replace(/ INNER~::~{1,}JOIN /ig,"~::~INNER JOIN ").replace(/ LEFT~::~{1,}JOIN /ig,"~::~LEFT JOIN ").replace(/ RIGHT~::~{1,}JOIN /ig,"~::~RIGHT JOIN ").replace(/ ON /ig,"~::~"+t+"ON ").replace(/ OR /ig,"~::~"+t+t+"OR ").replace(/ ORDER\s{1,}BY/ig,"~::~ORDER BY ").replace(/ OVER /ig,"~::~"+t+"OVER ").replace(/\(\s{0,}SELECT /ig,"~::~(SELECT ").replace(/\)\s{0,}SELECT /ig,")~::~SELECT ").replace(/ THEN /ig," THEN~::~"+t+"").replace(/ UNION /ig,"~::~UNION~::~").replace(/ USING /ig,"~::~USING ").replace(/ WHEN /ig,"~::~"+t+"WHEN ").replace(/ WHERE /ig,"~::~WHERE ").replace(/ WITH /ig,"~::~WITH ").replace(/ ALL /ig," ALL ").replace(/ AS /ig," AS ").replace(/ ASC /ig," ASC ").replace(/ DESC /ig," DESC ").replace(/ DISTINCT /ig," DISTINCT ").replace(/ EXISTS /ig," EXISTS ").replace(/ NOT /ig," NOT ").replace(/ NULL /ig," NULL ").replace(/ LIKE /ig," LIKE ").replace(/\s{0,}SELECT /ig,"SELECT ").replace(/\s{0,}UPDATE /ig,"UPDATE ").replace(/ SET /ig," SET ").replace(/~::~{1,}/g,"~::~").split("~::~")}return t.prototype.xml=function(t,n){var r=t.replace(/>\s{0,}</g,"><").replace(/</g,"~::~<").replace(/\s*xmlns\:/g,"~::~xmlns:").replace(/\s*xmlns\=/g,"~::~xmlns=").split("~::~"),i=r.length,s=!1,o=0,u="",a=0,f=n?e(n):this.shift;for(a=0;a<i;a++)if(r[a].search(/<!/)>-1){u+=f[o]+r[a],s=!0;if(r[a].search(/-->/)>-1||r[a].search(/\]>/)>-1||r[a].search(/!DOCTYPE/)>-1)s=!1}else r[a].search(/-->/)>-1||r[a].search(/\]>/)>-1?(u+=r[a],s=!1):/^<\w/.exec(r[a-1])&&/^<\/\w/.exec(r[a])&&/^<[\w:\-\.\,]+/.exec(r[a-1])==/^<\/[\w:\-\.\,]+/.exec(r[a])[0].replace("/","")?(u+=r[a],s||o--):r[a].search(/<\w/)>-1&&r[a].search(/<\//)==-1&&r[a].search(/\/>/)==-1?u=s?u+=r[a]:u+=f[o++]+r[a]:r[a].search(/<\w/)>-1&&r[a].search(/<\//)>-1?u=s?u+=r[a]:u+=f[o]+r[a]:r[a].search(/<\//)>-1?u=s?u+=r[a]:u+=f[--o]+r[a]:r[a].search(/\/>/)>-1?u=s?u+=r[a]:u+=f[o]+r[a]:r[a].search(/<\?/)>-1?u+=f[o]+r[a]:r[a].search(/xmlns\:/)>-1||r[a].search(/xmlns\=/)>-1?u+=f[o]+r[a]:u+=r[a];return u[0]=="\n"?u.slice(1):u},t.prototype.json=function(e,t){var t=t?t:this.step;return typeof JSON=="undefined"?e:typeof e=="string"?JSON.stringify(JSON.parse(e),null,t):typeof e=="object"?JSON.stringify(e,null,t):e},t.prototype.css=function(t,n){var r=t.replace(/\s{1,}/g," ").replace(/\{/g,"{~::~").replace(/\}/g,"~::~}~::~").replace(/\;/g,";~::~").replace(/\/\*/g,"~::~/*").replace(/\*\//g,"*/~::~").replace(/~::~\s{0,}~::~/g,"~::~").split("~::~"),i=r.length,s=0,o="",u=0,a=n?e(n):this.shift;for(u=0;u<i;u++)/\{/.exec(r[u])?o+=a[s++]+r[u]:/\}/.exec(r[u])?o+=a[--s]+r[u]:/\*\\/.exec(r[u])?o+=a[s]+r[u]:o+=a[s]+r[u];return o.replace(/^\n{1,}/,"")},t.prototype.sql=function(t,i){var s=t.replace(/\s{1,}/g," ").replace(/\'/ig,"~::~'").split("~::~"),o=s.length,u=[],a=0,f=this.step,l=!0,c=!1,h=0,p="",d=0,v=i?e(i):this.shift;for(d=0;d<o;d++)d%2?u=u.concat(s[d]):u=u.concat(r(s[d],f));o=u.length;for(d=0;d<o;d++){h=n(u[d],h),/\s{0,}\s{0,}SELECT\s{0,}/.exec(u[d])&&(u[d]=u[d].replace(/\,/g,",\n"+f+f+"")),/\s{0,}\s{0,}SET\s{0,}/.exec(u[d])&&(u[d]=u[d].replace(/\,/g,",\n"+f+f+"")),/\s{0,}\(\s{0,}SELECT\s{0,}/.exec(u[d])?(a++,p+=v[a]+u[d]):/\'/.exec(u[d])?(h<1&&a&&a--,p+=u[d]):(p+=v[a]+u[d],h<1&&a&&a--);var m=0}return p=p.replace(/^\n{1,}/,"").replace(/\n{1,}/g,"\n"),p},t.prototype.xmlmin=function(e,t){var n=t?e:e.replace(/\<![ \r\n\t]*(--([^\-]|[\r\n]|-[^\-])*--[ \r\n\t]*)\>/g,"").replace(/[ \r\n\t]{1,}xmlns/g," xmlns");return n.replace(/>\s{0,}</g,"><")},t.prototype.jsonmin=function(e){return typeof JSON=="undefined"?e:JSON.stringify(JSON.parse(e),null,0)},t.prototype.cssmin=function(e,t){var n=t?e:e.replace(/\/\*([^*]|[\r\n]|(\*+([^*/]|[\r\n])))*\*+\//g,"");return n.replace(/\s{1,}/g," ").replace(/\{\s{1,}/g,"{").replace(/\}\s{1,}/g,"}").replace(/\;\s{1,}/g,";").replace(/\/\*\s{1,}/g,"/*").replace(/\*\/\s{1,}/g,"*/")},t.prototype.sqlmin=function(e){return e.replace(/\s{1,}/g," ").replace(/\s{1,}\(/,"(").replace(/\s{1,}\)/,")")},new t}),n("vis/utils",["lib/d3","lib/vkbeautify"],function(e,t){function n(e,t){var n=parseFloat(e.style("width"))-t.left-t.right,r=parseFloat(e.style("height"))-t.top-t.bottom;return{width:n,height:r}}function r(e,t){var n=parseFloat(e.attr("width"))-t.left-t.right,r=parseFloat(e.attr("height"))-t.top-t.bottom;return{width:n,height:r}}function i(e,t){if(e===undefined)return t;var n=-1,r=t,i=window.Object.keys(e);while(++n<i.length)r[i[n]]=e[i[n]];return r}function s(t,i,s,o){var u=function(t,r,i){t&&(e.select("body").style("margin","0").style("padding","0"),r.style("height",window.innerHeight-i.top+"px"),r.style("width",window.innerWidth-i.left+"px"),r.style("margin-left",i.left+"px"),r.style("margin-top",i.top+"px"));var s=n(r,i);return s.svg=r.append("svg").attr("width",s.width).attr("height",s.height).attr("xmlns","http://www.w3.org/2000/svg"),s},a;return i?(a=r(t,s),a.svg=t):t?a=u(o,t,s):a=u(o,e.select("body").append("div"),s),(a.height<=0||a.width<=0)&&console.warn("Container has invalid height or 			 width. Try setting styles for height 			 and width, or use the 'fill_screen' option."),a}function o(e,t,i,s){function u(e,t,r){e&&(t.style("height",window.innerHeight-r.top+"px"),t.style("width",window.innerWidth-r.left+"px"),t.style("margin-left",r.left+"px"),t.style("margin-top",r.top+"px"));var s=n(t,i);return t.select("svg").attr("height",s.height).attr("width",s.width),s}var o;return t?o=r(e,i):e?o=u(s,e,i):console.warn("No selection"),o}function u(e){var t=e.node();while(t.hasChildNodes())t.removeChild(t.lastChild)}function a(t,n){var r="";return t&&e.text(t,function(e,t){e&&console.warn(e),r=t,n(r)}),!1}function f(){return"omg yes"}function l(t,n,r,i){function s(e,t){return e.indexOf(t,e.length-t.length)!==-1}if(i){n&&console.warn("File "+n+" overridden by value."),r.call(t,null,i,n);return}if(!n){r.call(t,"No filename",null,n);return}s(n,"json")?e.json(n,function(e,t){r(e,t,n)}):s(n,"css")?e.text(n,function(e,t){r(e,t,n)}):r.call(t,"Unrecognized file type",null,n);return}function c(e,t,n){var r=-1,i=t.length,s={};while(++r<t.length){var o=t[r].file;s[o]=t[r].callback,l(e,o,function(t,r,o){s[o].call(e,t,r),--i||n.call(e)},t[r].value)}}function h(t,n,r,s,o){var u=i(o,{padding:{left:0,right:0,top:0,bottom:0},x_is_log:!1,y_is_log:!1,y_ticks:null,x_ticks:null,x_nice:!1,y_nice:!1,x_tick_format:null,y_tick_format:null}),a={};return u.x_is_log?a.x=e.scale.log():a.x=e.scale.linear(),a.x.range([u.padding.left,r-u.padding.right]).domain(t),n?(u.y_is_log?a.y=e.scale.log():a.y=e.scale.linear(),a.y.range([s-u.padding.bottom,1+u.padding.top]).domain(n)):a.y=null,t?(a.x_axis=e.svg.axis().scale(a.x).orient("bottom"),u.x_nice&&a.x_axis.nice(),u.x_ticks&&a.x_axis.ticks(u.x_ticks),u.x_tick_format&&a.x_axis.tickFormat(u.x_tick_format)):a.x=null,a.y_axis=e.svg.axis().scale(a.y).orient("left"),u.y_nice&&a.y_axis.nice(),u.y_ticks&&a.y_axis.ticks(u.y_ticks),u.y_tick_format&&a.y_axis.tickFormat(u.y_tick_format),a}function p(e,t,n,r,i,s,o){var u,a,f,l,c,h,p;return e=="x"?(u="x axis",a=[0,s-o.bottom],f=i,l=-6,p=0,c=0,h=0):e=="y"?(u="y axis",a=[o.left,0],f=0,l=6,p=-90,c=0,h=".71em"):console.warn("Bad axis type"),n.append("g").attr("class",u).attr("transform","translate("+a+")").call(r).append("text").attr("class","label").attr("transform","rotate("+p+")").attr("x",f).attr("y",l).attr("dx",c).attr("dy",h).style("text-anchor","end").text(t)}function d(){var e,t=function(n){if(!(this instanceof t)){e=!0;var r=new t(arguments);return e=!1,r}typeof this.init=="function"&&this.init.apply(this,e?n:arguments)};return t}function v(e,t){e.select("defs").remove();var n=e.append("defs");return n.append("style").attr("type","text/css").text(t),n}function m(t,n,r,i,s){var o=e.select(t).selectAll(n).data(r);o.enter().call(i),o.call(s),o.exit().remove()}function g(t,n,r,i,s,o){var u=e.select(t).selectAll(n).data(y(r,i),function(e){return e[i]});u.enter().call(s),u.call(o),u.exit().remove()}function y(e,t){var n=[];for(var r in e){var i=b(e[r]);i[t]=r,n.push(i)}return n}function b(e){if(null==e||"object"!=typeof e)return e;if(e instanceof Array){var t=[];for(var n=0,r=e.length;n<r;n++)t[n]=b(e[n]);return t}if(e instanceof Object){var t={};for(var i in e)e.hasOwnProperty(i)&&(t[i]=b(e[i]));return t}throw new Error("Unable to copy obj! Its type isn't supported.")}function w(e,t){for(var n in t)n in e?console.error("Attribute "+n+" already in object."):e[n]=t[n]}function E(e){var t=[];return e.forEach(function(e){e.forEach(function(e){t.indexOf(e)<0&&t.push(e)})}),t}function S(e,t){return e===null||t===null||e===undefined||t===undefined?null:{x:e.x+t.x,y:e.y+t.y}}function x(e,t){return e===null||t===null||e===undefined||t===undefined?null:{x:e.x-t.x,y:e.y-t.y}}function T(e,t){return{x:e.x*t,y:e.y*t}}function N(e,t){function s(e){return window.btoa(unescape(encodeURIComponent(e)))}var n=document.createElement("a");n.download=t+".json";var r=JSON.stringify(e);n.setAttribute("href-lang","text/json"),n.href="data:image/svg+xml;base64,"+s(r);var i=document.createEvent("MouseEvents");i.initMouseEvent("click",!0,!1,self,0,0,0,0,0,!1,!1,!1,!1,0,null),n.dispatchEvent(i)}function C(e,t,n){window.File&&window.FileReader&&window.FileList&&window.Blob||t.call(n,"The File APIs are not fully supported in this browser.",null);var r=new window.FileReader;r.onload=function(e){var r=JSON.parse(e.target.result);t.call(n,null,r)},r.readAsText(e)}function k(n,r,i){function a(e){return window.btoa(unescape(encodeURIComponent(e)))}var s=document.createElement("a"),o,u;s.download=n+".svg",o=(new XMLSerializer).serializeToString(e.select(r).node()),i&&(o=t.xml(o)),o='<?xml version="1.0" encoding="utf-8"?>\n             <!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 1.1//EN"\n         "http://www.w3.org/Graphics/SVG/1.1/DTD/svg11.dtd">\n'+o,s.setAttribute("href-lang","image/svg+xml"),s.href="data:image/svg+xml;base64,"+a(o),u=document.createEvent("MouseEvents"),u.initMouseEvent("click",!0,!1,self,0,0,0,0,0,!1,!1,!1,!1,0,null),s.dispatchEvent(u)}function L(e,t,n){var r=function(e){return A(e,t,n)};return e.map(r)}function A(e,t,n){var r=Math.cos(-t)*(e.x-n.x)+Math.sin(-t)*(e.y-n.y)+n.x-e.x,i=-Math.sin(-t)*(e.x-n.x)+Math.cos(-t)*(e.y-n.y)+n.y-e.y;return{x:r,y:i}}function O(e){var t=e[1].x-e[0].x,n=e[1].y-e[0].y;return t==0&&n>=0?Math.PI/2:t==0&&n<0?3*Math.PI/2:t>=0&&n>=0?Math.atan(n/t):t>=0?Math.atan(n/t)+2*Math.PI:Math.atan(n/t)+Math.PI}function M(e){return e*180/Math.PI}function _(e,t){return Math.sqrt(Math.pow(t.y-e.y,2)+Math.pow(t.x-e.x,2))}function D(e,t){t.map(function(n,r){e[r]===undefined&&console.error("Argument is undefined: "+String(t[r]))})}return{set_options:i,setup_svg:s,resize_svg:o,remove_child_nodes:u,load_css:a,load_files:c,load_the_file:l,scale_and_axes:h,add_generic_axis:p,make_class:d,setup_defs:v,draw_an_array:m,draw_an_object:g,make_array:y,clone:b,extend:w,unique_concat:E,c_plus_c:S,c_minus_c:x,c_times_scalar:T,download_json:N,load_json:C,export_svg:k,rotate_coords_recursive:L,rotate_coords:A,get_angle:O,to_degrees:M,distance:_,check_undefined:D}}),n("lib/complete.ly",[],function(){return function(e,t){function h(e){return l===undefined&&(l=document.createElement("span"),l.style.visibility="hidden",l.style.position="fixed",l.style.outline="0",l.style.margin="0",l.style.padding="0",l.style.border="0",l.style.left="0",l.style.whiteSpace="pre",l.style.fontSize=t.fontSize,l.style.fontFamily=t.fontFamily,l.style.fontWeight="normal",document.body.appendChild(l)),l.innerHTML=String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),l.getBoundingClientRect().right}t=t||{},t.fontSize=t.fontSize||"16px",t.fontFamily=t.fontFamily||"sans-serif",t.promptInnerHTML=t.promptInnerHTML||"",t.color=t.color||"#333",t.hintColor=t.hintColor||"#aaa",t.backgroundColor=t.backgroundColor||"#fff",t.dropDownBorderColor=t.dropDownBorderColor||"#aaa",t.dropDownZIndex=t.dropDownZIndex||"100",t.dropDownOnHoverBackgroundColor=t.dropDownOnHoverBackgroundColor||"#ddd";var n=document.createElement("input");n.type="text",n.spellcheck=!1,n.style.fontSize=t.fontSize,n.style.fontFamily=t.fontFamily,n.style.color=t.color,n.style.backgroundColor=t.backgroundColor,n.style.width="100%",n.style.outline="0",n.style.border="0",n.style.margin="0",n.style.padding="0";var r=n.cloneNode();r.disabled="",r.style.position="absolute",r.style.top="0",r.style.left="0",r.style.borderColor="transparent",r.style.boxShadow="none",r.style.color=t.hintColor,n.style.backgroundColor="transparent",n.style.verticalAlign="top",n.style.position="relative";var i=document.createElement("div");i.style.position="relative",i.style.outline="0",i.style.border="0",i.style.margin="0",i.style.padding="0";var s=document.createElement("div");s.style.position="absolute",s.style.outline="0",s.style.margin="0",s.style.padding="0",s.style.border="0",s.style.fontSize=t.fontSize,s.style.fontFamily=t.fontFamily,s.style.color=t.color,s.style.backgroundColor=t.backgroundColor,s.style.top="0",s.style.left="0",s.style.overflow="hidden",s.innerHTML=t.promptInnerHTML,s.style.background="transparent";if(document.body===undefined)throw"document.body is undefined. The library was wired up incorrectly.";document.body.appendChild(s);var o=s.getBoundingClientRect().right;i.appendChild(s),s.style.visibility="visible",s.style.left="-"+o+"px",i.style.marginLeft=o+"px",i.appendChild(r),i.appendChild(n);var u=document.createElement("div");u.style.position="absolute",u.style.visibility="hidden",u.style.outline="0",u.style.margin="0",u.style.padding="0",u.style.textAlign="left",u.style.fontSize=t.fontSize,u.style.fontFamily=t.fontFamily,u.style.backgroundColor=t.backgroundColor,u.style.zIndex=t.dropDownZIndex,u.style.cursor="default",u.style.borderStyle="solid",u.style.borderWidth="1px",u.style.borderColor=t.dropDownBorderColor,u.style.overflowX="hidden",u.style.whiteSpace="pre",u.style.overflowY="scroll";var a=function(e){var n=[],r=0,i=-1,s=function(){this.style.outline="1px solid #ddd"},o=function(){this.style.outline="0"},u=function(){a.hide(),a.onmouseselection(this.__hint)},a={hide:function(){e.style.visibility="hidden"},refresh:function(i,f){e.style.visibility="hidden",r=0,e.innerHTML="";var l=window.innerHeight||document.documentElement.clientHeight,c=e.parentNode.getBoundingClientRect(),h=c.top-6,p=l-c.bottom-6;n=[];for(var d=0;d<f.length;d++){if(f[d].indexOf(i)!==0)continue;var v=document.createElement("div");v.style.color=t.color,v.onmouseover=s,v.onmouseout=o,v.onmousedown=u,v.__hint=f[d],v.innerHTML=i+"<b>"+f[d].substring(i.length)+"</b>",n.push(v),e.appendChild(v)}if(n.length===0)return;if(n.length===1&&i===n[0].__hint)return;if(n.length<2)return;a.highlight(0),h>p*3?(e.style.maxHeight=h+"px",e.style.top="",e.style.bottom="100%"):(e.style.top="100%",e.style.bottom="",e.style.maxHeight=p+"px"),e.style.visibility="visible"},highlight:function(e){i!=-1&&n[i]&&(n[i].style.backgroundColor=t.backgroundColor),n[e].style.backgroundColor=t.dropDownOnHoverBackgroundColor,i=e},move:function(t){return e.style.visibility==="hidden"?"":r+t===-1||r+t===n.length?n[r].__hint:(r+=t,a.highlight(r),n[r].__hint)},onmouseselection:function(){}};return a},f=a(u);f.onmouseselection=function(e){n.value=r.value=c+e,p.onChange(n.value),d=n.value,setTimeout(function(){n.focus()},0)},i.appendChild(u),e.appendChild(i);var l,c,p={onArrowDown:function(){},onArrowUp:function(){},onEnter:function(){},onTab:function(){},onChange:function(){p.repaint()},startFrom:0,options:[],wrapper:i,input:n,hint:r,dropDown:u,prompt:s,setText:function(e){r.value=e,n.value=e},getText:function(){return n.value},hideDropDown:function(){f.hide()},repaint:function(){var e=n.value,t=p.startFrom,i=p.options,s=i.length,o=e.substring(t);c=e.substring(0,t),r.value="";for(var a=0;a<s;a++){var l=i[a];if(l.indexOf(o)===0){r.value=c+l;break}}u.style.left=h(c)+"px",f.refresh(o,p.options)}},d,v=function(e,t){d=e.value;var n=function(){var n=e.value;d!==n&&(d=n,t(n))};e.addEventListener?(e.addEventListener("input",n,!1),e.addEventListener("keyup",n,!1),e.addEventListener("change",n,!1)):(e.attachEvent("oninput",n),e.attachEvent("onkeyup",n),e.attachEvent("onchange",n))};v(n,function(e){p.onChange(e)});var m=function(e){e=e||window.event;var t=e.keyCode;if(t==33)return;if(t==34)return;if(t==27){f.hide(),r.value=n.value,n.focus();return}if(t==39||t==35||t==9){t==9&&(e.preventDefault(),e.stopPropagation(),r.value.length==0&&p.onTab());if(r.value.length>0){f.hide(),n.value=r.value;var i=d!=n.value;d=n.value,i&&p.onChange(n.value)}return}if(t==13){if(r.value.length==0)p.onEnter();else{var s=u.style.visibility=="hidden";f.hide();if(s){r.value=n.value,n.focus(),p.onEnter();return}n.value=r.value;var i=d!=n.value;d=n.value,i&&p.onChange(n.value)}return}if(t==40){var o=f.move(1);o==""&&p.onArrowDown(),r.value=c+o;return}if(t==38){var o=f.move(-1);o==""&&p.onArrowUp(),r.value=c+o,e.preventDefault(),e.stopPropagation();return}r.value=""};return n.addEventListener?n.addEventListener("keydown",m,!1):n.attachEvent("onkeydown",m),p}}),n("builder/draw",["vis/utils","lib/d3"],function(e,t){function n(e){e.on("mousedown.drag",null),e.on("touchstart.drag",null)}function r(t){e.check_undefined(arguments,["enter_selection"]),t.append("rect").attr("class","membrane")}function i(t,n){e.check_undefined(arguments,["enter_selection","scale"]),t.attr("width",function(e){return n.x_size(e.width)}).attr("height",function(e){return n.y_size(e.height)}).attr("transform",function(e){return"translate("+n.x(e.x)+","+n.y(e.y)+")"}).style("stroke-width",function(e){return n.size(10)}).attr("rx",function(e){return n.x_size(20)}).attr("ry",function(e){return n.x_size(20)})}function s(t){e.check_undefined(arguments,["enter_selection"]);var n=t.append("g").attr("id",function(e){return e.reaction_id}).attr("class","reaction").call(u);return}function o(t,n,r,i,s,o,u,c,h,p,d){e.check_undefined(arguments,["update_selection","scale","drawn_nodes","show_beziers","arrow_displacement","defs","arrowheads","default_reaction_color","has_flux","bezier_drag_behavior","label_drag_behavior"]),t.select(".reaction-label").call(function(e){return a(e,n,h,d)});var v=t.selectAll(".segment-group").data(function(t){return e.make_array(t.segments,"segment_id")},function(e){return e.segment_id});v.enter().call(f),v.call(function(e){return l(e,n,r,i,s,o,u,c,h,p)}),v.exit().remove()}function u(t){e.check_undefined(arguments,["sel"]),t.append("text").attr("class","reaction-label label").style("cursor","default")}function a(r,i,s,o){e.check_undefined(arguments,["sel","scale","has_flux","label_drag_behavior"]);var u=t.format(".4g");r.text(function(e){var t=e.abbreviation;return e.flux?t+=" ("+u(e.flux)+")":s&&(t+=" (0)"),t}).attr("transform",function(e){return"translate("+i.x(e.label_x)+","+i.y(e.label_y)+")"}).style("font-size",function(e){return String(i.size(30))+"px"}).call(n).call(o)}function f(t){e.check_undefined(arguments,["enter_selection"]);var n=t.append("g").attr("class","segment-group").attr("id",function(e){return e.segment_id});n.append("path").attr("class","segment"),n.append("g").attr("class","beziers")}function l(r,i,s,o,u,a,f,l,c,h){function d(n){e.check_undefined(arguments,["enter_selection"]),n.append("circle").attr("class",function(e){return"bezier bezier"+e.bezier}).style("stroke-width",String(i.size(1))+"px").attr("r",String(i.size(5))+"px").on("mouseover",function(e){t.select(this).style("stroke-width",String(i.size(3))+"px")}).on("mouseout",function(e){t.select(this).style("stroke-width",String(i.size(1))+"px")})}function g(t,r,s){e.check_undefined(arguments,["update_selection","show_beziers","drag_behavior"]),t.call(n).call(s),r?t.attr("visibility","visible").attr("transform",function(e){return e.x==null||e.y==null?"":"translate("+i.x(e.x)+","+i.y(e.y)+")"}):t.attr("visibility","hidden")}e.check_undefined(arguments,["update_selection","scale","drawn_nodes","show_beziers","arrow_displacement","defs","arrowheads","default_reaction_color","has_flux","bezier_drag_behavior"]),r.selectAll(".segment").datum(function(){return this.parentNode.__data__}).attr("d",function(e){if(e.from_node_id==null||e.to_node_id==null)return null;var t=s[e.from_node_id],n=s[e.to_node_id],r=e.b1,o=e.b2;return t["node_type"]=="metabolite"&&(t=v(u,t,r,"start")),n["node_type"]=="metabolite"&&(n=v(u,o,n,"end")),e.b1==null||e.b2==null?"M"+i.x(t.x)+","+i.y(t.y)+" "+i.x(n.x)+","+i.y(n.y):"M"+i.x(t.x)+","+i.y(t.y)+"C"+i.x(r.x)+","+i.y(r.y)+" "+i.x(o.x)+","+i.y(o.y)+" "+i.x(n.x)+","+i.y(n.y)}).attr("marker-start",function(e){var t=s[e.from_node_id];if(t["node_type"]=="metabolite"){var n=e.flux?i.flux_color(Math.abs(e.flux)):l,r=m(a,f,n,!1);return"url(#"+r+")"}return null}).attr("marker-end",function(e){var t=s[e.to_node_id];if(t["node_type"]=="metabolite"){var n=e.flux?i.flux_color(Math.abs(e.flux)):l,r=m(a,f,n,!0);return"url(#"+r+")"}return null}).style("stroke",function(e){return c?e.flux?i.flux_color(Math.abs(e.flux)):i.flux_color(0):l}).style("stroke-width",function(e){return e.flux?i.size(i.flux(Math.abs(e.flux))):i.size(i.flux(1))});var p=r.select(".beziers").selectAll(".bezier").data(function(e){var t=[],n=this.parentNode.parentNode.parentNode.__data__.reaction_id,r=this.parentNode.parentNode.__data__.segment_id;return e.b1!=null&&e.b1.x!=null&&e.b1.y!=null&&t.push({bezier:1,x:e.b1.x,y:e.b1.y,reaction_id:n,segment_id:r}),e.b2!=null&&e.b2.x!=null&&e.b2.y!=null&&t.push({bezier:2,x:e.b2.x,y:e.b2.y,reaction_id:n,segment_id:r}),t},function(e){return e.bezier});p.enter().call(function(e){return d(e)}),p.call(function(e){return g(e,o,h)}),p.exit().remove()}function c(n,r,i,s){e.check_undefined(arguments,["enter_selection","scale","drawn_nodes","drawn_reactions"]);var o=n.append("g").attr("class","node").attr("id",function(e){return e.node_id});o.append("circle").attr("class",function(e){return e.node_type=="metabolite"?"node-circle metabolite-circle":"node-circle"}).style("stroke-width",String(r.size(2))+"px").on("mouseover",function(e){t.select(this).style("stroke-width",String(r.size(3))+"px")}).on("mouseout",function(e){t.select(this).style("stroke-width",String(r.size(2))+"px")}),o.filter(function(e){return e.node_type=="metabolite"}).append("text").attr("class","node-label label").style("cursor","default")}function h(r,i,s,o,u,a,f){e.check_undefined(arguments,["update_selection","scale","has_node_data","node_data_style","click_fn","drag_behavior","label_drag_behavior"]);var l=r.select(".node-circle").attr("transform",function(e){return"translate("+i.x(e.x)+","+i.y(e.y)+")"}).attr("r",function(e){return e.node_type=="metabolite"?s&&o.indexOf("Size")!==1?i.size(i.node_size(e.data)):i.size(e.node_is_primary?15:10):i.size(5)}).style("fill",function(e){if(e.node_type=="metabolite")return s&&o.indexOf("Color")!==1?i.node_color(e.data):"rgb(224, 134, 91)"}).call(n).call(a).on("click",u);r.select(".node-label").attr("transform",function(e){return"translate("+i.x(e.label_x)+","+i.y(e.label_y)+")"}).style("font-size",function(e){return String(i.size(20))+"px"}).text(function(e){var n=t.format(".4g"),r=e.bigg_id_compartmentalized;return e.data?r+=" ("+n(e.data)+")":s&&(r+=" (0)"),r}).call(n).call(f)}function p(t){e.check_undefined(arguments,["enter_selection"]),t.append("text").attr("class","text-label label").style("cursor","default").text(function(e){return e.text})}function d(t,r,i,s){e.check_undefined(arguments,["update_selection","scale","label_click","label_drag_behavior"]),t.attr("transform",function(e){return"translate("+r.x(e.x)+","+r.y(e.y)+")"}).on("click",i).call(n).call(s)}function v(t,n,r,i){e.check_undefined(arguments,["reaction_arrow_displacement","start","end","displace"]);var s=t,o=e.distance(n,r),u,a;return(!s||!o)&&console.error("Bad value"),i=="start"?(u=n.x+s*(r.x-n.x)/o,a=n.y+s*(r.y-n.y)/o):i=="end"?(u=r.x-s*(r.x-n.x)/o,a=r.y-s*(r.y-n.y)/o):console.error("bad displace value: "+i),{x:u,y:a}}function m(t,n,r,i){e.check_undefined(arguments,["defs","arrowheads_generated","color","is_end"]);var s=i?"start-":"end-",o=String(r).replace("#",s);if(n.indexOf(o)<0){n.push(o);var u=5,a=5,f,l=u/2,c;i?f=0:f=a,i?c="M0,0 V"+u+" L"+a/2+","+u/2+" Z":c="M"+a+",0 V"+u+" L"+a/2+","+u/2+" Z",t.append("svg:marker").attr("id",o).attr("class","arrowhead").attr("refX",f).attr("refY",l).attr("markerWidth",u).attr("markerHeight",a).attr("orient","auto").append("svg:path").attr("d",c).style("fill",r)}return o}return{create_reaction:s,update_reaction:o,create_node:c,update_node:h,create_text_label:p,update_text_label:d,create_membrane:r,update_membrane:i}}),n("builder/build",["vis/utils","lib/d3"],function(e,t){function n(t,n,i,s,u,a,f){f=Math.PI/180*f;var l=String(++u.reactions),c={x:s.x,y:s.y},h=300,p=[c,e.c_plus_c(c,{x:h,y:0})],d={x:(p[0].x+p[1].x)/2,y:(p[0].y+p[1].y)/2},v={x:30,y:10},m=20,g=n.reversibility?"Reversible":"Irreversible",y={abbreviation:t,direction:g,label_x:d.x+v.x,label_y:d.y+v.y,name:n.name,segments:{}},b=[],w=[],E=0,S=0,x=!1;for(var T in n.metabolites){var N=n.metabolites[T];if(N.coefficient<0){N.index=E;var C=/C([0-9]+)/.exec(N.formula);s.bigg_id_compartmentalized==N.bigg_id_compartmentalized?b.push([N.index,Infinity]):C&&a.indexOf(N.bigg_id)==-1&&b.push([N.index,parseInt(C[1])]),E++}else{N.index=S;var C=/C([0-9]+)/.exec(N.formula);s.bigg_id_compartmentalized==N.bigg_id_compartmentalized?(w.push([N.index,Infinity]),x=!0):C&&a.indexOf(N.bigg_id)==-1&&w.push([N.index,parseInt(C[1])]),S++}}var k=function(e,t){return t[1]>e[1]?t:e},L=b.reduce(k,[0,0])[0],A=w.reduce(k,[0,0])[0];for(var T in n.metabolites){var N=n.metabolites[T];N.coefficient<0?(N.index==L&&(N.is_primary=!0),N.count=E+1):(N.index==A&&(N.is_primary=!0),N.count=S+1)}var O={},M=[{node_type:"anchor_reactants",dis:{x:m*(x?1:-1),y:0}},{node_type:"center",dis:{x:0,y:0}},{node_type:"anchor_products",dis:{x:m*(x?-1:1),y:0}}],_={};M.map(function(e){var t=String(++u.nodes);O[t]={node_type:e.node_type,x:d.x+e.dis.x,y:d.y+e.dis.y,connected_segments:[]},_[e.node_type]=t});var D=[[_.anchor_reactants,_.center],[_.anchor_products,_.center]];D.map(function(e){var t=e[0],n=e[1],r=String(++u.segments);y.segments[r]={b1:null,b2:null,from_node_id:t,to_node_id:n},O[t].connected_segments.push({segment_id:r,reaction_id:l}),O[n].connected_segments.push({segment_id:r,reaction_id:l})});var P=O;for(var T in n.metabolites){N=n.metabolites[T];var H,B;N.coefficient<0?(H=L,B=_.anchor_reactants):(H=A,B=_.anchor_products);var j=o(N,H,p,d,h,x);if(N.bigg_id_compartmentalized==s.bigg_id_compartmentalized){var F=String(++u.segments);y.segments[F]={from_node_id:B,to_node_id:i,b1:j.b1,b2:j.b2},s.connected_segments.push({segment_id:F,reaction_id:l}),P[B].connected_segments.push({segment_id:F,reaction_id:l})}else{var F=String(++u.segments),I=String(++u.nodes);y.segments[F]={from_node_id:B,to_node_id:I,b1:j.b1,b2:j.b2},P[I]={connected_segments:[{segment_id:F,reaction_id:l}],x:j.circle.x,y:j.circle.y,node_is_primary:N.is_primary,compartment_name:N.compartment,label_x:j.circle.x+v.x,label_y:j.circle.y+v.y,metabolite_name:N.name,bigg_id:N.bigg_id,bigg_id_compartmentalized:N.bigg_id_compartmentalized,node_type:"metabolite"},P[B].connected_segments.push({segment_id:F,reaction_id:l})}}var q={};q[l]=y,P[i]=s;var R=r(P,q,f,c);return{new_reactions:q,new_nodes:P}}function r(t,n,r,i){var o=function(t){return t===null?null:e.rotate_coords(t,r,i)},u=[],a=[];for(var f in t){var l=t[f],c=o({x:l.x,y:l.y}),h=s(l,n,c);l.connected_segments.map(function(t){var r=n[t.reaction_id];if(r===undefined)return;var i=r.segments[t.segment_id];if(i.to_node_id==f&&i.b2){var s=o(i.b2);i.b2=e.c_plus_c(i.b2,s)}else if(i.from_node_id==f&&i.b1){var s=o(i.b1);i.b1=e.c_plus_c(i.b1,s)}}),a=e.unique_concat([a,h.reaction_ids]),u.push(f)}return{node_ids:u,reaction_ids:a}}function i(t,n,r,i){var o=s(t,r,i);return t.connected_segments.map(function(t){var s=r[t.reaction_id];if(s===undefined)return;var u=s.segments[t.segment_id];u.from_node_id==n&&u.b1&&(u.b1=e.c_plus_c(u.b1,i)),u.to_node_id==n&&u.b2&&(u.b2=e.c_plus_c(u.b2,i)),o.reaction_ids.indexOf(t.reaction_id)<0&&o.reaction_ids.push(t.reaction_id)}),o}function s(e,t,n){e.x=e.x+n.x,e.y=e.y+n.y,e.label_x=e.label_x+n.x,e.label_y=e.label_y+n.y;var r=[];return e.connected_segments.map(function(i){var s=t[i.reaction_id];r.indexOf(i.reaction_id)<0&&(r.push(i.reaction_id),e.node_type=="center"&&(s.label_x=s.label_x+n.x,s.label_y=s.label_y+n.y))}),{reaction_ids:r}}function o(t,n,r,i,s,o){var u=r[0],r=[e.c_minus_c(r[0],u),e.c_minus_c(r[1],u)],i=e.c_minus_c(i,u),a=80,f=.4,l=.25,c=a*.7,h=40,p=Math.min(2,t.count-1),d,v,m;t.is_primary?d=20:(d=10,t.index>n?v=t.index-1:v=t.index);var g=s-d,y=[{x:d,y:0},{x:g,y:0}],b,w,E,S;t.coefficient<0!=o&&t.is_primary?(b={x:y[0].x,y:y[0].y},E={x:i.x*(1-f)+y[0].x*f,y:i.y*(1-f)+y[0].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[0].x,y:r[0].y}):t.coefficient<0!=o?(b={x:y[0].x+h,y:y[0].y+(c*v-c*(p-1)/2)},E={x:i.x*(1-f)+y[0].x*f,y:i.y*(1-f)+y[0].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[0].x+h,y:r[0].y+(a*v-a*(p-1)/2)}):t.coefficient>0!=o&&t.is_primary?(b={x:y[1].x,y:y[1].y},E={x:i.x*(1-f)+y[1].x*f,y:i.y*(1-f)+y[1].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[1].x,y:r[1].y}):t.coefficient>0!=o&&(b={x:y[1].x-h,y:y[1].y+(c*v-c*(p-1)/2)},E={x:i.x*(1-f)+y[1].x*f,y:i.y*(1-f)+y[1].y*f},S={x:i.x*l+b.x*(1-l),y:i.y*l+b.y*(1-l)},w={x:r[1].x-h,y:r[1].y+(a*v-a*(p-1)/2)});var x={};return x.b1=e.c_plus_c(u,E),x.b2=e.c_plus_c(u,S),x.circle=e.c_plus_c(u,w),x}return{new_reaction:n,rotate_nodes:r,move_node_and_dependents:i}}),n("builder/Behavior",["vis/utils","lib/d3","builder/build"],function(e,t,n){function i(e,t){this.map=e,this.undo_stack=t,this.empty_behavior=function(){},this.node_click=null,this.node_drag=this.empty_behavior,this.bezier_drag=this.empty_behavior,this.reaction_label_drag=this.empty_behavior,this.node_label_drag=this.empty_behavior,this.text_label_click=null,this.text_label_drag=this.empty_behavior,this.turn_everything_on()}function s(){this.toggle_node_click(!0),this.toggle_node_drag(!0),this.toggle_text_label_click(!0),this.toggle_label_drag(!0)}function o(){this.toggle_node_click(!1),this.toggle_node_drag(!1),this.toggle_text_label_click(!1),this.toggle_label_drag(!1)}function u(e){e===undefined&&(e=this.node_click==null);if(e){var n=this.map;this.node_click=function(e){n.select_metabolite(this,e),t.event.stopPropagation()}}else this.node_click=null}function a(e){e===undefined&&(e=this.text_label_click==null);if(e){var n=this.map;this.text_label_click=function(e){n.select_text_label(this,e),t.event.stopPropagation()}}else this.text_label_click=null}function f(e){e===undefined&&(e=this.node_drag===this.empty_behavior),e?(this.node_drag=this.get_node_drag(this.map,this.undo_stack),this.bezier_drag=this.get_bezier_drag(this.map,this.undo_stack)):this.node_drag=this.empty_behavior}function l(e){e===undefined&&(e=this.label_drag===this.empty_behavior),e?(this.reaction_label_drag=this.get_reaction_label_drag(this.map,this.scale),this.node_label_drag=this.get_node_label_drag(this.map,this.scale),this.text_label_drag=this.get_text_label_drag(this.map,this.scale)):(this.reaction_label_drag=this.empty_behavior,this.node_label_drag=this.empty_behavior,this.text_label_drag=this.empty_behavior)}function c(r,i){function l(n,i){var s=r.nodes[i],o=r.nodes[n],u=[];s.connected_segments.forEach(function(t){var s=r.reactions[t.reaction_id].segments[t.segment_id];if(s.from_node_id==i)s.from_node_id=n;else{if(s.to_node_id!=i)return console.error("Segment does not connect to dragged node");s.to_node_id=n}o.connected_segments.push(t),u.push(e.clone(t))});var a={};return a[i]=s,r.delete_node_data(a),t.selectAll(".node-to-combine").classed("node-to-combine",!1),r.draw_everything(),u}var s=t.behavior.drag(),o=null,u=null,a=null,f=null;return s.on("dragstart",function(){var e=this.parentNode.__data__,n=e.bigg_id_compartmentalized,i=this.parentNode;t.event.sourceEvent.stopPropagation(),o={},f=window.setTimeout(function(){i.parentNode.insertBefore(i,i.parentNode.firstChild)},200),t.selectAll(".metabolite-circle").on("mouseover.combine",function(i){i.bigg_id_compartmentalized==n&&i.node_id!=e.node_id&&t.select(this).style("stroke-width",String(r.scale.size(12))+"px").classed("node-to-combine",!0)}).on("mouseout.combine",function(e){e.bigg_id_compartmentalized==n&&t.selectAll(".node-to-combine").style("stroke-width",String(r.scale.size(2))+"px").classed("node-to-combine",!1)})}),s.on("drag",function(){var i=this.parentNode.__data__.node_id,s=r.get_selected_node_ids();u=[],s.indexOf(i)==-1?u.push(i):u=s,a=[],u.forEach(function(i){var s=r.nodes[i],u={x:r.scale.x_size.invert(t.event.dx),y:r.scale.y_size.invert(t.event.dy)},f=n.move_node_and_dependents(s,i,r.reactions,u);a=e.unique_concat([a,f.reaction_ids]),i in o||(o[i]={x:0,y:0}),o[i]=e.c_plus_c(o[i],u)}),r.draw_these_nodes(u),r.draw_these_reactions(a)}),s.on("dragend",function(){if(u===null){o=null,u=null,a=null,f=null;return}var s=[];t.selectAll(".node-to-combine").each(function(e){s.push(e.node_id)});if(s.length==1){var c=s[0],h=this.parentNode.__data__.node_id,p=e.clone(r.nodes[h]),d=l(c,h);i.push(function(){r.nodes[h]=p;var e=r.nodes[c],t=[];d.forEach(function(n){var i=r.reactions[n.reaction_id].segments[n.segment_id];i.from_node_id==c?i.from_node_id=h:i.to_node_id==c?i.to_node_id=h:console.error("Segment does not connect to fixed node"),e.connected_segments=e.connected_segments.filter(function(e){return e.reaction_id!=n.reaction_id||e.segment_id!=n.segment_id}),t.indexOf(n.reaction_id)==-1&&t.push(n.reaction_id)}),r.draw_these_nodes([h]),r.draw_these_reactions(t)},function(){l(c,h)})}else{var v=e.clone(o),m=e.clone(u),g=e.clone(a);i.push(function(){m.forEach(function(t){var i=r.nodes[t];n.move_node_and_dependents(i,t,r.reactions,e.c_times_scalar(v[t],-1))}),r.draw_these_nodes(m),r.draw_these_reactions(g)},function(){m.forEach(function(e){var t=r.nodes[e];n.move_node_and_dependents(t,e,r.reactions,v[e])}),r.draw_these_nodes(m),r.draw_these_reactions(g)})}t.selectAll(".metabolite-circle").on("mouseover.combine",null).on("mouseout.combine",null),window.clearTimeout(f),o=null,u=null,a=null,f=null}),s}function h(t,n){var r=function(n,r,i,s){var o=t.reactions[n].segments[r];o["b"+i]=e.c_plus_c(o["b"+i],s)},i=function(e){},s=function(e,n,i){r(e.reaction_id,e.segment_id,e.bezier,n),t.draw_these_reactions([e.reaction_id])},o=function(e){},u=function(n,i){r(n.reaction_id,n.segment_id,n.bezier,e.c_times_scalar(i,-1)),t.draw_these_reactions([n.reaction_id])},a=function(e,n){r(e.reaction_id,e.segment_id,e.bezier,n),t.draw_these_reactions([e.reaction_id])};return this.get_generic_drag(i,s,o,u,a)}function p(t,n){var r=function(e,n){var r=t.reactions[e];r.label_x=r.label_x+n.x,r.label_y=r.label_y+n.y},i=function(e){},s=function(e,n,i){r(e.reaction_id,n),t.draw_these_reactions([e.reaction_id])},o=function(e){},u=function(n,i){r(n.reaction_id,e.c_times_scalar(i,-1)),t.draw_these_reactions([n.reaction_id])},a=function(e,n){r(e.reaction_id,n),t.draw_these_reactions([e.reaction_id])};return this.get_generic_drag(i,s,o,u,a)}function d(t,n){var r=function(e,n){var r=t.nodes[e];r.label_x=r.label_x+n.x,r.label_y=r.label_y+n.y},i=function(e){},s=function(e,n,i){r(e.node_id,n),t.draw_these_nodes([e.node_id])},o=function(e){},u=function(n,i){r(n.node_id,e.c_times_scalar(i,-1)),t.draw_these_nodes([n.node_id])},a=function(e,n){r(e.node_id,n),t.draw_these_nodes([e.node_id])};return this.get_generic_drag(i,s,o,u,a)}function v(t,n){var r=function(e,n){var r=t.text_labels[e];r.x=r.x+n.x,r.y=r.y+n.y},i=function(e){},s=function(e,n,i){r(e.text_label_id,n),t.draw_these_text_labels([e.text_label_id])},o=function(e){},u=function(n,i){r(n.text_label_id,e.c_times_scalar(i,-1)),t.draw_these_text_labels([n.text_label_id])},a=function(e,n){r(e.text_label_id,n),t.draw_these_text_labels([e.text_label_id])};return this.get_generic_drag(i,s,o,u,a)}function m(n,r,i,s,o){var u=t.behavior.drag(),a,f=this.map.scale,l=this.undo_stack;return u.on("dragstart",function(e){t.event.sourceEvent.stopPropagation(),a={x:0,y:0},n(e)}),u.on("drag",function(n){var i={x:f.x_size.invert(t.event.dx),y:f.y_size.invert(t.event.dy)};a=e.c_plus_c(a,i),r(n,i,a)}),u.on("dragend",function(t){var n=e.clone(t),r=e.clone(a);l.push(function(){s(n,r)},function(){o(n,r)}),i(t)}),u}var r=e.make_class();return r.prototype={init:i,turn_everything_on:s,turn_everything_off:o,toggle_node_click:u,toggle_node_drag:f,toggle_text_label_click:a,toggle_label_drag:l,get_node_drag:c,get_bezier_drag:h,get_reaction_label_drag:p,get_node_label_drag:d,get_text_label_drag:v,get_generic_drag:m},r}),n("builder/Scale",["vis/utils","lib/d3"],function(e,t){function r(n,r,i,s,o){var u=e.set_options(o,{flux_color:t.scale.linear().domain([0,1e-6,1,8,50]).range(["rgb(200,200,200)","rgb(190,190,255)","rgb(100,100,255)","blue","red"])}),a=Math.min(i/n,s/r);u.x=t.scale.linear().domain([0,n]).range([(i-n*a)/2,n*a+(i-n*a)/2]),u.y=t.scale.linear().domain([0,r]).range([(s-r*a)/2,r*a+(s-r*a)/2]),u.x_size=t.scale.linear().domain([0,n]).range([0,n*a]),u.y_size=t.scale.linear().domain([0,r]).range([0,r*a]),u.size=t.scale.linear().domain([0,1]).range([0,a]),u.flux=t.scale.linear().domain([0,40]).range([6,6]),u.flux_fill=t.scale.linear().domain([0,40,200]).range([1,1,1]),u.node_size=t.scale.linear().range([5,25]),u.node_color=t.scale.linear().range(["white","red"]),u.metabolite_concentration=t.scale.linear().domain([0,10]).range([15,200]),u.metabolite_color=t.scale.linear().domain([0,1.2]).range(["#FEF0D9","#B30000"]),u.scale_path=function(e){var n=u.x,r=u.y,i=t.format(".2f"),e=e.replace(/(M|L)([0-9-.]+),?\s*([0-9-.]+)/g,function(e,t,s,o){return t+[i(n(parseFloat(s))),i(r(parseFloat(o)))].join(", ")}),s=/C([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)\s*([0-9-.]+),?\s*([0-9-.]+)/g;return e=e.replace(s,function(e,t,s,o,u,a,f){return"C"+i(n(parseFloat(t)))+","+i(r(parseFloat(s)))+" "+i(n(parseFloat(o)))+","+i(r(parseFloat(u)))+" "+[i(n(parseFloat(a)))+","+i(r(parseFloat(f)))]}),e},u.scale_decimals=function(e,n,r){var i=t.format("."+String(r)+"f");return e=e.replace(/([0-9.]+)/g,function(e,t){return i(n(parseFloat(t)))}),e};var f=window.Object.keys(u),l=-1;while(++l<f.length)this[f[l]]=u[f[l]]}var n=e.make_class();return n.prototype={init:r},n}),n("builder/DirectionArrow",["vis/utils","lib/d3"],function(e,t){function r(e){function t(){return"M0 -5 L0 5 L20 5 L20 10 L30 0 L20 -10 L20 -5 Z"}this.arrow_container=e.append("g").attr("id","direction-arrow-container").attr("transform","translate(0,0)rotate(0)"),this.arrow=this.arrow_container.append("path").classed("direction-arrow",!0).attr("d",t()).style("visibility","hidden").attr("transform","translate(2,0)scale(0.15)")}function i(e){var n=t.transform(this.arrow_container.attr("transform"));this.arrow_container.attr("transform","translate("+e.x+","+e.y+")rotate("+n.rotate+")")}function s(e){var n=t.transform(this.arrow_container.attr("transform"));this.arrow_container.attr("transform","translate("+n.translate+")rotate("+e+")")}function o(){return t.transform(this.arrow_container.attr("transform")).rotate}function u(){this.arrow.style("visibility","visible")}function a(){this.arrow.style("visibility","hidden")}function f(){this.set_rotation(0)}function l(){this.set_rotation(90)}function c(){this.set_rotation(180)}function h(){this.set_rotation(270)}var n=e.make_class();return n.prototype={init:r,set_location:i,set_rotation:s,get_rotation:o,show:u,hide:a,right:f,left:c,up:h,down:l},n}),n("builder/UndoStack",["vis/utils"],function(e){function n(){var e=40;this.stack=Array(e),this.current=-1,this.oldest=-1,this.newest=-1,this.end_of_stack=!0,this.top_of_stack=!0}function r(e,t){this.current=o(this.current,this.stack.length),this.end_of_stack?this.oldest=this.current:this.oldest==this.current&&(this.oldest=o(this.oldest,this.stack.length)),this.stack[this.current]={undo:e,redo:t},this.newest=this.current,this.top_of_stack=!0,this.end_of_stack=!1}function i(){if(this.end_of_stack)return console.warn("End of stack.");this.stack[this.current].undo(),this.current==this.oldest?this.end_of_stack=!0:this.current=u(this.current,this.stack.length),this.top_of_stack=!1}function s(){if(this.top_of_stack)return console.warn("Top of stack.");this.end_of_stack||(this.current=o(this.current,this.stack.length)),this.stack[this.current].redo(),this.current==this.newest&&(this.top_of_stack=!0),this.end_of_stack=!1}function o(e,t){return e+1>t-1?0:e+1}function u(e,t){return e-1<0?t-1:e-1}var t=e.make_class();return t.prototype={init:n,push:r,undo:i,redo:s},t}),n("vis/CallbackManager",["vis/utils"],function(e){function n(){}function r(e,t){return this.callbacks===undefined&&(this.callbacks={}),this.callbacks[e]===undefined&&(this.callbacks[e]=[]),this.callbacks[e].push(t),this}function i(e){return(this.callbacks===undefined||Object.keys(this.callbacks).length==0)&&console.warn("No callbacks to remove"),delete this.callbacks[e],this}function s(e){if(this.callbacks===undefined)return this;var t=Array.prototype.slice.call(arguments,1);for(var n in this.callbacks){var r=n.split(".")[0];r==e&&this.callbacks[n].forEach(function(e){e.apply(null,t)})}return this}var t=e.make_class();return t.prototype={init:n,set:r,remove:i,run:s},t}),n("builder/KeyManager",["vis/utils","lib/d3"],function(e,t){function r(e){e.command=!1,e.control=!1,e.option=!1,e.shift=!1}function i(e,t){e===undefined&&(e={}),t===undefined&&(t=null),this.assigned_keys=e,this.held_keys={},r(this.held_keys),this.update()}function s(){function o(e,t,n,r){for(var i in e)e[i]==n&&(t[i]=r)}function u(e,t,n){if(e.key!=t)return!1;var r=e.modifiers;r===undefined&&(r={control:!1,command:!1,option:!1,shift:!1});for(var i in n){r[i]===undefined&&(r[i]=!1);if(r[i]!=n[i])return!1}return!0}var e=this.held_keys,n=this.assigned_keys,i=this,s={command:91,control:17,option:18,shift:16};t.select(window).on("keydown.key_manager",null),t.select(window).on("keyup.key_manager",null),t.select(window).on("keydown.key_manager",function(){var a=t.event.keyCode,f=i.reaction_input?i.reaction_input.is_visible:!1,l=!0;o(s,e,a,!0);for(var c in n){var h=n[c];if(u(h,a,e)){l=!1;if(!h.ignore_with_input||!f)h.fn?h.fn.call(h.target):console.warn("No function for key"),t.event.preventDefault()}}for(var p in s)s[p]==a&&(l=!1);l&&r(e)}).on("keyup.key_manager",function(){o(s,e,t.event.keyCode,!1)})}function o(e){var n=t.select(window);return n.on("keydown.esc",function(){t.event.keyCode==27&&(e(),n.on("keydown.esc",null))}),{clear:function(){n.on("keydown.esc",null)}}}var n=e.make_class();return n.reset_held_keys=r,n.prototype={init:i,update:s,add_escape_listener:o},n}),n("builder/Canvas",["vis/utils","lib/d3"],function(e,t){function r(e,t){this.selection=e,this.x=t.x,this.y=t.y,this.width=t.width,this.height=t.height,this.setup()}function i(){function d(){t.event.sourceEvent.stopPropagation()}function v(e,n,r){var i=t.transform(r),s=i.translate;return e!==null&&(s[0]=e),n!==null&&(s[1]=n),"translate("+s+")"}function m(n){var i=n.x;n.x=Math.min(n.x+e.width-r/2,t.event.x),e.x=n.x,e.width=e.width+(i-n.x),l.attr("transform",function(e){return v(e.x-r/2,null,l.attr("transform"))}),s.attr("transform",function(e){return v(e.x,null,s.attr("transform"))}).attr("width",e.width),h.attr("transform",function(e){return v(e.x+r/2,null,h.attr("transform"))}).attr("width",e.width-r),p.attr("transform",function(e){return v(e.x+r/2,null,p.attr("transform"))}).attr("width",e.width-r)}function g(n){t.event.sourceEvent.stopPropagation();var i=Math.max(n.x+r/2,n.x+e.width+t.event.dx);e.width=i-n.x,c.attr("transform",function(e){return v(i-r/2,null,c.attr("transform"))}),s.attr("width",e.width),h.attr("width",e.width-r),p.attr("width",e.width-r)}function y(n){t.event.sourceEvent.stopPropagation();var i=n.y;n.y=Math.min(n.y+e.height-r/2,t.event.y),e.y=n.y,e.height=e.height+(i-n.y),h.attr("transform",function(e){return v(null,e.y-r/2,h.attr("transform"))}),s.attr("transform",function(e){return v(null,e.y,s.attr("transform"))}).attr("height",e.height),l.attr("transform",function(e){return v(null,e.y+r/2,l.attr("transform"))}).attr("height",e.height-r),c.attr("transform",function(e){return v(null,e.y+r/2,c.attr("transform"))}).attr("height",e.height-r)}function b(n){t.event.sourceEvent.stopPropagation();var i=Math.max(n.y+r/2,n.y+e.height+t.event.dy);e.height=i-n.y,p.attr("transform",function(e){return v(null,i-r/2,p.attr("transform"))}),s.attr("height",e.height),l.attr("height",e.height-r),c.attr("height",e.height-r)}var e=this,n={x:this.width,y:this.height},r=20,i=this.selection.append("g").classed("canvas-group",!0).data([{x:this.x,y:this.y}]),s=i.append("rect").attr("id","mouse-node").attr("width",this.width).attr("height",this.height).attr("transform","translate("+[e.x,e.y]+")").attr("class","canvas").attr("pointer-events","all"),o=t.behavior.drag().origin(Object).on("dragstart",d).on("drag",g),u=t.behavior.drag().origin(Object).on("dragstart",d).on("drag",m),a=t.behavior.drag().origin(Object).on("dragstart",d).on("drag",y),f=t.behavior.drag().origin(Object).on("dragstart",d).on("drag",b),l=i.append("rect").attr("transform",function(e){return"translate("+[e.x-r/2,e.y+r/2]+")"}).attr("height",this.height-r).attr("id","dragleft").attr("width",r).attr("cursor","ew-resize").classed("resize-rect",!0).call(u),c=i.append("rect").attr("transform",function(t){return"translate("+[t.x+e.width-r/2,t.y+r/2]+")"}).attr("id","dragright").attr("height",this.height-r).attr("width",r).attr("cursor","ew-resize").classed("resize-rect",!0).call(o),h=i.append("rect").attr("transform",function(e){return"translate("+[e.x+r/2,e.y-r/2]+")"}).attr("height",r).attr("id","dragleft").attr("width",this.width-r).attr("cursor","ns-resize").classed("resize-rect",!0).call(a),p=i.append("rect").attr("transform",function(t){return"translate("+[t.x+r/2,t.y+e.height-r/2]+")"}).attr("id","dragright").attr("height",r).attr("width",this.width-r).attr("cursor","ns-resize").classed("resize-rect",!0).call(f)}function s(){return{x:this.x,y:this.y,width:this.width,height:this.height}}var n=e.make_class();return n.prototype={init:r,setup:i,size_and_location:s},n}),n("builder/Map",["vis/utils","lib/d3","builder/draw","builder/Behavior","builder/Scale","builder/DirectionArrow","builder/build","builder/UndoStack","vis/CallbackManager","builder/KeyManager","builder/Canvas"],function(e,t,n,r,i,s,o,u,a,f,l){function h(e,t,n,o,c,h,p,d,v,m){m===undefined&&(m={x:0,y:0,width:c,height:o});var g=90;this.reaction_arrow_displacement=35,this.default_reaction_color="#505050",this.canvas=new l(e,m),this.setup_containers(e),this.sel=e,this.defs=t,this.zoom_container=n,this.height=o,this.width=c,this.flux=h,this.node_data=p,this.node_data_style=d,this.cobra_model=v,this.map_info={max_map_w:c*10,max_map_h:o*10},this.map_info.largest_ids={reactions:-1,nodes:-1,segments:-1},this.scale=new i(this.map_info.max_map_w,this.map_info.max_map_h,c,o),this.undo_stack=new u,this.behavior=new r(this,this.undo_stack),this.key_manager=new f;var y={x:0,y:0},b=1;this.beziers_enabled=!1,this.direction_arrow=new s(e),this.direction_arrow.set_rotation(g),this.callback_manager=new a,this.arrowheads_generated=[],this.nodes={},this.reactions={},this.membranes=[],this.text_labels={},this.info={},this.debug=!1}function p(t,n,r,i,s,o,u,a,f,l){function g(e,t){return t===undefined&&(t=0),e===undefined?t:Math.max.apply(null,Object.keys(e).map(function(e){return parseInt(e)}).concat([t]))}e.check_undefined(arguments,["map_data","selection","defs","zoom_container","height","width","flux","node_data","node_data_style","cobra_model"]),t=d(t);var h;t.canvas&&(h=t.canvas);var p=new c(n,r,i,s,o,u,a,f,l,h);t.reactions&&(p.reactions=t.reactions),t.nodes&&(p.nodes=t.nodes),t.membranes&&(p.membranes=t.membranes),t.text_labels&&(p.text_labels=t.text_labels),t.info&&(p.info=t.info),p.map_info.largest_ids.reactions=g(p.reactions),p.map_info.largest_ids.nodes=g(p.nodes),p.map_info.largest_ids.text_labels=g(p.text_labels);var v=0;for(var m in p.reactions)v=g(p.reactions[m].segments,v);return p.map_info.largest_ids.segments=v,u&&p.apply_flux_to_map(),a&&p.apply_node_data_to_map(),p}function d(e){if(this.debug){var t=["node_type","x","y","connected_segments"],n=["segments","name","direction","abbreviation"],r=["from_node_id","to_node_id"],i=["text","x","y"];for(var s in e.nodes){var o=e.nodes[s];o.selected=!1,o.previously_selected=!1,t.map(function(e){o.hasOwnProperty(e)||console.error("Missing property "+e)})}for(var u in e.reactions){var a=e.reactions[u];n.map(function(e){a.hasOwnProperty(e)||console.error("Missing property "+e)});for(var f in a.segments){var l=a.segments[f];r.map(function(e){l.hasOwnProperty(e)||console.error("Missing property "+e)})}}for(var c in e.text_labels){var h=e.text_labels[c];i.map(function(e){h.hasOwnProperty(e)||console.error("Missing property "+e)})}}return e}function v(e){e.append("g").attr("id","membranes"),e.append("g").attr("id","reactions"),e.append("g").attr("id","nodes"),e.append("g").attr("id","text-labels")}function m(){t.select("#membranes").selectAll(".membrane").remove(),t.select("#reactions").selectAll(".reaction").remove(),t.select("#nodes").selectAll(".node").remove(),t.select("#text-labels").selectAll(".text-label").remove()}function g(e){this.status=e,this.callback_manager.run("set_status",e)}function y(e){this.flux=e,this.apply_flux_to_map(),this.draw_all_reactions()}function b(e){this.node_data=e,this.apply_node_data_to_map(),this.draw_all_nodes()}function w(){return Boolean(this.flux)}function E(){return Boolean(this.node_data)}function S(){var t=this.membranes,r=this.scale,i=this.reactions,s=this.nodes,o=this.text_labels,u=this.reaction_arrow_displacement,a=this.defs,f=this.arrowheads_generated,l=this.default_reaction_color,c=this.behavior.bezier_drag,h=this.behavior.node_click,p=this.behavior.node_drag,d=this.behavior.reaction_label_drag,v=this.behavior.node_label_drag,m=this.behavior.text_label_click,g=this.behavior.text_label_drag,y=this.node_data_style,b=this.has_flux(),w=this.has_node_data(),E=this.beziers_enabled;e.draw_an_array("#membranes",".membrane",t,n.create_membrane,function(e){return n.update_membrane(e,r)}),e.draw_an_object("#reactions",".reaction",i,"reaction_id",function(e){return n.create_reaction(e)},function(e){return n.update_reaction(e,r,s,E,u,a,f,l,b,c,d)}),e.draw_an_object("#nodes",".node",s,"node_id",function(e){return n.create_node(e,r,s,i)},function(e){return n.update_node(e,r,w,y,h,p,v)}),e.draw_an_object("#text-labels",".text-label",o,"text_label_id",function(e){return n.create_text_label(e)},function(e){return n.update_text_label(e,r,m,g)})}function x(){var e=[];for(var t in this.reactions)e.push(t);this.draw_these_reactions(e)}function T(r){var i=this.scale,s=this.reactions,o=this.nodes,u=this.reaction_arrow_displacement,a=this.defs,f=this.arrowheads_generated,l=this.default_reaction_color,c=this.behavior.bezier_drag,h=this.behavior.reaction_label_drag,p=this.has_flux(),d=this.beziers_enabled,v={},m=-1;while(++m<r.length)v[r[m]]=e.clone(s[r[m]]);r.length!=Object.keys(v).length&&console.warn("did not find correct reaction subset");var g=t.select("#reactions").selectAll(".reaction").data(e.make_array(v,"reaction_id"),function(e){return e.reaction_id});g.enter().call(n.create_reaction),g.call(function(e){return n.update_reaction(e,i,o,d,u,a,f,l,p,c,h)}),g.exit()}function N(){var e=[];for(var t in this.nodes)e.push(t);this.draw_these_nodes(e)}function C(r){var i=this.scale,s=this.reactions,o=this.nodes,u=this.behavior.node_click,a=this.behavior.node_drag,f=this.behavior.node_label_drag,l=this.node_data_style,c=this.has_node_data(),h={},p=-1;while(++p<r.length)h[r[p]]=e.clone(o[r[p]]);r.length!=Object.keys(h).length&&console.warn("did not find correct node subset");var d=t.select("#nodes").selectAll(".node").data(e.make_array(h,"node_id"),function(e){return e.node_id});d.enter().call(function(e){return n.create_node(e,i,o,s)}),d.call(function(e){return n.update_node(e,i,c,l,u,a,f)}),d.exit()}function k(r){var i=this.scale,s=this.text_labels,o=this.behavior.text_label_click,u=this.behavior.text_label_drag,a={},f=-1;while(++f<r.length)a[r[f]]=e.clone(s[r[f]]);r.length!=Object.keys(a).length&&console.warn("did not find correct text label subset");var l=t.select("#text-labels").selectAll(".text-label").data(e.make_array(a,"text_label_id"),function(e){return e.text_label_id});l.enter().call(function(e){return n.create_text_label(e)}),l.call(function(e){return n.update_text_label(e,i,o,u)}),l.exit()}function L(){this.apply_flux_to_reactions(this.reactions)}function A(e){for(var t in e){var n=e[t];if(n.abbreviation in this.flux){var r=parseFloat(this.flux[n.abbreviation]);n.flux=r;for(var i in n.segments){var s=n.segments[i];s.flux=r}}else{var r=0;n.flux=r;for(var i in n.segments){var s=n.segments[i];s.flux=r}}}}function O(){this.apply_node_data_to_nodes(this.nodes)}function M(e){var t=[];for(var n in e){var r=e[n],i=0;r.bigg_id_compartmentalized in this.node_data&&(i=parseFloat(this.node_data[r.bigg_id_compartmentalized])),isNaN(i)?r.data=0:(t.push(i),r.data=i)}var s=Math.min.apply(null,t),o=Math.max.apply(null,t);this.scale.node_size.domain([s,o]),this.scale.node_color.domain([s,o])}function _(e){var t=this.nodes[e],n={x:t.x,y:t.y};return n}function D(){var e=[];return t.select("#nodes").selectAll(".selected").each(function(t){e.push(t.node_id)}),e}function P(){var e={},n=this;return t.select("#nodes").selectAll(".selected").each(function(t){e[t.node_id]=n.nodes[t.node_id]}),e}function H(){var e=[];return t.select("#text-labels").selectAll(".selected").each(function(t){e.push(t.text_label_id)}),e}function B(){var e={},n=this;return t.select("#text-labels").selectAll(".selected").each(function(t){e[t.text_label_id]=n.text_labels[t.text_label_id]}),e}function j(e){this.deselect_text_labels();var t=this.sel.select("#nodes").selectAll(".node"),n,r=this.scale,i;t.classed("selected",function(t){var s=String(t.node_id)==String(e);return s&&(i=t,n={x:r.x(t.x),y:r.y(t.y)}),s}),this.direction_arrow.set_location(n),this.direction_arrow.show(),this.sel.selectAll(".start-reaction-target").style("visibility","hidden"),this.callback_manager.run("select_metabolite_with_id",i,n)}function F(e,n){this.deselect_text_labels();var r=this.sel.select("#nodes").selectAll(".node"),i=this.key_manager.held_keys.shift;i?t.select(e.parentNode).classed("selected",!t.select(e.parentNode).classed("selected")):r.classed("selected",function(e){return n===e});var s=t.select("#nodes").selectAll(".selected"),o=0,u,a=this.scale,f;s.each(function(e){f=e,u={x:a.x(e.x),y:a.y(e.y)},o++}),o==1?(this.direction_arrow.set_location(u),this.direction_arrow.show()):this.direction_arrow.hide(),this.callback_manager.run("select_metabolite",o,f,u)}function I(){var e=null,t=this,n=this.sel.select("#nodes").selectAll(".selected");return n.classed("selected",function(t,n){return n==0?(e=t,!0):!1}),e}function q(){var e=this.sel.select("#nodes").selectAll(".node");e.classed("selected",!1)}function R(e,n){this.deselect_nodes();var r=this.sel.select("#text-labels").selectAll(".text-label");r.classed("selected",function(e){return n===e});var i=t.select("#text-labels").selectAll(".selected"),s,o=this.scale;i.each(function(e){s={x:o.x(e.x),y:o.y(e.y)}}),this.callback_manager.run("select_text_label")}function U(){var e=this.sel.select("#text-labels").selectAll(".text-label");e.classed("selected",!1)}function z(){var e=this.get_selected_nodes();Object.keys(e).length>=1&&this.delete_nodes(e);var t=this.get_selected_text_labels();Object.keys(t).length>=1&&this.delete_text_labels(t)}function W(t){var n=this.segments_and_reactions_for_nodes(t),r=n.reactions,i=n.segment_objs_w_segments,s=e.clone(t),o=e.clone(i),u=e.clone(r),a=this,f=function(e,n,r){a.delete_node_data(t),a.delete_segment_data(r),a.delete_reaction_data(n),a.draw_everything()};f(t,r,i),this.undo_stack.push(function(){e.extend(a.nodes,s),e.extend(a.reactions,u);var n=Object.keys(u);o.forEach(function(e){var t=e.segment;a.reactions[e.reaction_id].segments[e.segment_id]=t,[t.from_node_id,t.to_node_id].forEach(function(t){if(t in s)return;var n=a.nodes[t];n.connected_segments.push({reaction_id:e.reaction_id,segment_id:e.segment_id})}),n.push(e.reaction_id)}),a.draw_these_nodes(Object.keys(s)),a.draw_these_reactions(n),t=e.clone(s),i=e.clone(o),r=e.clone(u)},function(){f(t,r,i)})}function X(t){var n=e.clone(t),r=this,i=function(e){r.delete_text_label_data(t),r.draw_everything()};i(t),this.undo_stack.push(function(){e.extend(r.text_labels,n),r.draw_these_text_labels(Object.keys(n)),t=e.clone(n)},function(){i(t)})}function V(e){for(var t in e)delete this.nodes[t]}function $(e){var t=this.reactions,n=this.nodes;e.forEach(function(e){var r=t[e.reaction_id];if(!(e.segment_id in r.segments))return;var i=r.segments[e.segment_id];[i.from_node_id,i.to_node_id].forEach(function(t){if(!(t in n))return;var r=n[t];r.connected_segments=r.connected_segments.filter(function(t){return t.segment_id!=e.segment_id})}),delete r.segments[e.segment_id]})}function J(e){for(var t in e)delete this.reactions[t]}function K(e){for(var t in e)delete this.text_labels[t]}function Q(){this.toggle_beziers(!0)}function G(){this.toggle_beziers(!1)}function Y(e){e===undefined?this.beziers_enabled=!this.beziers_enabled:this.beziers_enabled=e,this.draw_everything(),this.callback_manager.run("toggle_beziers",this.beziers_enabled)}function Z(t,n){function p(t,n){e.extend(this.nodes,t),this.draw_these_nodes([n])}for(var r in this.reactions)if(this.reactions[r].abbreviation==t){console.warn("reaction is already drawn");return}this.cobra_model||console.error("No CobraModel. Cannot build new reaction");var i=e.clone(this.cobra_model.reactions[t]);for(var s in i.metabolites){var o=i.metabolites[s];if(o.coefficient<0){var u=++this.map_info.largest_ids.nodes,a={x:30,y:10},f={connected_segments:[],x:n.x,y:n.y,node_is_primary:!0,compartment_name:o.compartment,label_x:n.x+a.x,label_y:n.y+a.y,metabolite_name:o.name,bigg_id:o.bigg_id,bigg_id_compartmentalized:o.bigg_id_compartmentalized,node_type:"metabolite"},l={};l[u]=f;break}}p.apply(this,[l,u]);var c=e.clone(l),h=this;this.undo_stack.push(function(){h.delete_node_data(l),l=e.clone(c),h.draw_everything()},function(){p.apply(h,[l,u])}),this.new_reaction_for_metabolite(t,u)}function et(t,n){function p(t,n,r){e.extend(this.reactions,n),delete this.nodes[r],e.extend(this.nodes,t),this.draw_these_nodes(Object.keys(t)),this.draw_these_reactions(Object.keys(n));for(var i in t){var s=t[i];if(s.node_is_primary&&i!=r){this.select_metabolite_with_id(i);var o={x:s.x,y:s.y};this.zoom_container&&this.zoom_container.translate_off_screen(o,this.scale.x,this.scale.y)}}}for(var r in this.reactions)if(this.reactions[r].abbreviation==t){console.warn("reaction is already drawn");return}var i=this.nodes[n],s=e.clone(this.cobra_model.reactions[t]),u=o.new_reaction(t,s,n,e.clone(i),this.map_info.largest_ids,this.cobra_model.cofactors,this.direction_arrow.get_rotation()),a=u.new_nodes,f=u.new_reactions;this.flux&&this.apply_flux_to_reactions(f),this.node_data&&this.apply_node_data_to_nodes(a),p.apply(this,[a,f,n]);var l=e.clone(a),c=e.clone(f),h=this;this.undo_stack.push(function(){delete a[n],h.delete_node_data(a),h.delete_reaction_data(f),j.apply(h,[n]),a=e.clone(l),f=e.clone(c),h.draw_everything()},function(){p.apply(h,[a,f,n])})}function tt(){var e=this.get_selected_nodes(),t=Object.keys(e)[0],n=e[t],r=this.reactions,i=this.nodes,s=[],o;i[t].connected_segments.forEach(function(e){o=[e.reaction_id];var n=r[e.reaction_id].segments[e.segment_id];s.push(n.from_node_id==t?n.to_node_id:n.from_node_id)});if(s.length!=1)return console.error("Only connected nodes with a single reaction can be selected");var u=s[0],a=[t],f=[];i[u].connected_segments.forEach(function(e){var n=r[e.reaction_id].segments[e.segment_id],s=n.from_node_id==u?n.to_node_id:n.from_node_id,o=i[s];o.node_type=="metabolite"&&s!=t&&a.push(String(s))});for(var l=0;l<a.length;l++)if(i[a[l]].connected_segments.length>1)return console.error("Only connected nodes with a single reaction can be selected");for(var c in e)if(c!=t&&a.indexOf(c)==-1)return console.warn("Selected nodes are not on the same reaction");var h=[],p=a.length-1,d=i[a[p]],v=d.node_is_primary,m={x:d.x,y:d.y,label_x:d.label_x,label_y:d.label_y},g=d.connected_segments[0],y=r[g.reaction_id].segments[g.segment_id],b={b1:y.b1,b2:y.b2},w;a.forEach(function(e){var t=i[e],n=t.node_is_primary,s={x:t.x,y:t.y,label_x:t.label_x,label_y:t.label_y},o=t.connected_segments[0],u=r[o.reaction_id].segments[o.segment_id],a={b1:u.b1,b2:u.b2};t.node_is_primary=v,t.x=m.x,t.y=m.y,t.label_x=m.label_x,t.label_y=m.label_y,u.b1=b.b1,u.b2=b.b2,v=n,m=s,b=a,t.node_is_primary&&(w=e),h.push(e)});var E=i[u].connected_segments,p=E.length-1,S=[E[p]];E.forEach(function(e,t){if(p==t)return;S.push(e)}),i[u].connected_segments=S,this.draw_these_nodes(h),this.draw_these_reactions(o),this.select_metabolite_with_id(w)}function nt(){var e=this.get_selected_nodes(),t=this.reactions,n=this.nodes;if(Object.keys(e).length!=1)return console.error("Only one node can be selected");var r=Object.keys(e)[0],i=e[r];n[r].node_is_primary=!0;var s=[r],o=[];n[r].connected_segments.forEach(function(e){var n=t[e.reaction_id].segments[e.segment_id];o.push(n.from_node_id==r?n.to_node_id:n.from_node_id)}),o.forEach(function(e){var i=[];n[e].connected_segments.forEach(function(i){var o=t[i.reaction_id].segments[i.segment_id],u=o.from_node_id==e?o.to_node_id:o.from_node_id,a=n[u];a.node_type=="metabolite"&&u!=r&&(a.node_is_primary=!1,s.push(u))})}),this.draw_these_nodes(s)}function rt(){function l(e,n){console.log("Choose center"),g("Choose a node or point to rotate around.");var r=t.selectAll(".node-circle"),i=t.selectAll("#mouse-node"),s=this.scale,o=this.key_manager.add_escape_listener(function(){console.log("choose_center escape"),r.on("mousedown.center",null),i.on("mousedown.center",null),g(""),n()});r.on("mousedown.center",function(t){console.log("mousedown.center"),r.on("mousedown.center",null),i.on("mousedown.center",null),g(""),o.clear();var n={x:t.x,y:t.y};e(n)}),i.on("mousedown.center",function(){console.log("mousedown.center"),r.on("mousedown.center",null),i.on("mousedown.center",null),g(""),o.clear();var n={x:s.x_size.invert(t.mouse(this)[0]),y:s.y_size.invert(t.mouse(this)[1])};e(n)})}function c(e,n,r,i){function l(e,t,n){var r=Math.atan2(t.x-n.x,n.y-t.y),i=Math.atan2(t.x-n.x+e.dx,n.y-t.y-e.dy),s=i-r;return s}this.set_status("Drag to rotate."),this.zoom_container.toggle_zoom(!1);var s=Math.PI/2,o=t.selectAll("#mouse-node"),u=t.behavior.drag(),a=this.scale,f=this.key_manager.add_escape_listener(function(){console.log("listen_for_rotation escape"),u.on("drag.rotate",null),u.on("dragend.rotate",null),g(""),i()});u.on("drag.rotate",function(){n(l({dx:a.x_size.invert(t.event.dx),dy:a.y_size.invert(t.event.dy)},{x:a.x_size.invert(t.mouse(this)[0]),y:a.y_size.invert(t.mouse(this)[1])},e))}).on("dragend.rotate",function(){console.log("dragend.rotate"),u.on("drag.rotate",null),u.on("dragend.rotate",null),g(""),f.clear(),r()}),o.call(u)}this.callback_manager.run("start_rotation");var e=this.get_selected_nodes();if(e.length<1)return console.warn("No nodes selected");var n,r=0,i=Object.keys(e),s=this,u=this.reactions,a=this.nodes,f=function(){s.callback_manager.run("end_rotation")};l.call(this,function(t){n=t,c.call(s,t,function(n){r+=n;var i=o.rotate_nodes(e,u,n,t);s.draw_these_nodes(i.node_ids),s.draw_these_reactions(i.reaction_ids)},f,f)},f),this.undo_stack.push(function(){var e={};i.forEach(function(t){e[t]=a[t]});var t=o.rotate_selected_nodes(e,u,-r,n);s.draw_these_nodes(t.node_ids),s.draw_these_reactions(t.reaction_ids)},function(){var e={};i.forEach(function(t){e[t]=a[t]});var t=o.rotate_selected_nodes(e,u,r,n);s.draw_these_nodes(t.node_ids),s.draw_these_reactions(t.reaction_ids)})}function it(t){var n=[],r={},i={},s=this.reactions;for(var o in t){var u=t[o];u.connected_segments.forEach(function(t){var r=s[t.reaction_id],o=r.segments[t.segment_id],u=e.clone(t);u.segment=e.clone(o),n.push(u),t.reaction_id in i||(i[t.reaction_id]=[]),i[t.reaction_id].push(t.segment_id)})}for(var a in i){var f=s[a],l=i[a],c=!0;for(var h in f.segments)l.indexOf(h)==-1&&(c=!1);c&&(r[a]=f)}return{segment_objs_w_segments:n,reactions:r}}function g(e){var n=t.select("body").select("#status");return n.empty()&&(n=t.select("body").append("text").attr("id","status")),n.text(e),this}function st(e){this._zoom_extent(e,"nodes")}function ot(e){this._zoom_extent(e,"canvas")}function ut(e,t){e===undefined&&(e=100),t===undefined&&(t="canvas");var n,r;if(t=="nodes"){var i={x:null,y:null},s={x:null,y:null};for(var o in this.nodes){var u=this.nodes[o];i.x===null&&(i.x=this.scale.x(u.x)),i.y===null&&(i.y=this.scale.y(u.y)),s.x===null&&(s.x=this.scale.x(u.x)),s.y===null&&(s.y=this.scale.y(u.y)),i.x=Math.min(i.x,this.scale.x(u.x)),i.y=Math.min(i.y,this.scale.y(u.y)),s.x=Math.max(s.x,this.scale.x(u.x)),s.y=Math.max(s.y,this.scale.y(u.y))}n=Math.min((this.width-e*2)/(s.x-i.x),(this.height-e*2)/(s.y-i.y)),r={x:-(i.x*n)+e+(this.width-e*2-(s.x-i.x)*n)/2,y:-(i.y*n)+e+(this.height-e*2-(s.y-i.y)*n)/2}}else{if(t!="canvas")return console.error("Did not recognize mode");n=Math.min((this.width-e*2)/this.canvas.width,(this.height-e*2)/this.canvas.height),r={x:-(this.canvas.x*n)+e+(this.width-e*2-this.canvas.width*n)/2,y:-(this.canvas.y*n)+e+(this.height-e*2-this.canvas.height*n)/2}}return this.zoom_container.go_to(n,r),null}function at(){console.log("Saving"),e.download_json(this.map_for_export(),"saved_map")}function ft(){return{reactions:this.reactions,nodes:this.nodes,membranes:this.membranes,text_labels:this.text_labels,canvas:this.canvas.size_and_location()}}function lt(){console.log("Exporting SVG"),this.callback_manager.run("before_svg_export"),e.export_svg("saved_map","svg"),this.callback_manager.run("after_svg_export")}var c=e.make_class();return c.from_data=p,c.prototype={init:h,setup_containers:v,reset_containers:m,set_status:g,set_flux:y,set_node_data:b,select_metabolite:F,select_metabolite_with_id:j,select_single_node:I,deselect_nodes:q,select_text_label:R,deselect_text_labels:U,new_reaction_from_scratch:Z,new_reaction_for_metabolite:et,cycle_primary_node:tt,make_selected_node_primary:nt,rotate_selected_nodes:rt,delete_selected:z,delete_nodes:W,delete_text_labels:X,delete_node_data:V,delete_segment_data:$,delete_reaction_data:J,delete_text_label_data:K,get_selected_node_ids:D,get_selected_nodes:P,get_selected_text_label_ids:H,get_selected_text_labels:B,segments_and_reactions_for_nodes:it,has_flux:w,has_node_data:E,draw_everything:S,draw_all_reactions:x,draw_these_reactions:T,draw_all_nodes:N,draw_these_nodes:C,draw_these_text_labels:k,apply_flux_to_map:L,apply_flux_to_reactions:A,apply_node_data_to_map:O,apply_node_data_to_nodes:M,get_selected_node_ids:D,toggle_beziers:Y,hide_beziers:G,show_beziers:Q,zoom_extent_nodes:st,zoom_extent_canvas:ot,_zoom_extent:ut,save:at,map_for_export:ft,save_svg:lt},c}),n("builder/ZoomContainer",["vis/utils","lib/d3","vis/CallbackManager"],function(e,t,n){function i(e,r,i,s){this.zoom_on=!0,this.initial_zoom=1,this.window_translate={x:0,y:0},this.window_scale=1,this.width=r,this.height=i,this.callback_manager=new n,e.select("#zoom-container").remove();var o=e.append("g").attr("id","zoom-container");this.zoomed_sel=o.append("g");var u=function(e,t){e.zoom_on&&(e.zoomed_sel.attr("transform","translate("+t.translate+")"+"scale("+t.scale+")"),e.window_translate={x:t.translate[0],y:t.translate[1]},e.window_scale=t.scale,e.callback_manager.run("zoom"))},a=this;this.zoom_behavior=t.behavior.zoom().on("zoom",function(){u(a,t.event)}),o.call(this.zoom_behavior),this.saved_scale=null,this.saved_translate=null}function s(t){t===undefined?this.zoom_on=!this.zoom_on:this.zoom_on=t,this.zoom_on?(this.saved_scale!==null&&(this.zoom_behavior.scale(this.saved_scale),this.saved_scale=null),this.saved_translate!==null&&(this.zoom_behavior.translate(this.saved_translate),this.saved_translate=null)):(this.saved_scale===null&&(this.saved_scale=e.clone(this.zoom_behavior.scale())),this.saved_translate===null&&(this.saved_translate=e.clone(this.zoom_behavior.translate())))}function o(e,t){if(!e)return console.error("Bad scale value");if(!!t&&"x"in t&&"y"in t){this.zoom_behavior.scale(e),this.window_scale=e,this.saved_scale!==null&&(this.saved_scale=e);var n=[t.x,t.y];return this.zoom_behavior.translate(n),this.window_translate=t,this.saved_translate!==null&&(this.saved_translate=n),this.zoomed_sel.transition().attr("transform","translate("+this.window_translate.x+","+this.window_translate.y+")"+"scale("+this.window_scale+")"),null}return console.error("Bad translate value")}function u(e,t,n){var r=80,i={x:{min:-this.window_translate.x/this.window_scale+r/this.window_scale,max:-this.window_translate.x/this.window_scale+(this.width-r)/this.window_scale},y:{min:-this.window_translate.y/this.window_scale+r/this.window_scale,max:-this.window_translate.y/this.window_scale+(this.height-r)/this.window_scale}};t(e.x)<i.x.min?(this.window_translate.x=this.window_translate.x-(t(e.x)-i.x.min)*this.window_scale,this.go_to(this.window_scale,this.window_translate)):t(e.x)>i.x.max&&(this.window_translate.x=this.window_translate.x-(t(e.x)-i.x.max)*this.window_scale,this.go_to(this.window_scale,this.window_translate)),n(e.y)<i.y.min?(this.window_translate.y=this.window_translate.y-(n(e.y)-i.y.min)*this.window_scale,this.go_to(this.window_scale,this.window_translate)):n(e.y)>i.y.max&&(this.window_translate.y=this.window_translate.y-(n(e.y)-i.y.max)*this.window_scale,this.go_to(this.window_scale,this.window_translate))}function a(){this.go_to(1,{x:0,y:0})}var r=e.make_class();return r.prototype={init:i,toggle_zoom:s,go_to:o,translate_off_screen:u,reset:a},r}),n("builder/Input",["lib/d3","vis/utils","lib/complete.ly","builder/Map","builder/ZoomContainer","vis/CallbackManager"],function(e,t,n,r,i,s){function u(t,o,u){var a=t.append("div").attr("id","rxn-input"),f=n(a.node(),{backgroundColor:"#eee"});e.select(f.input).on("input",function(){this.value=this.value.replace("/","").replace(" ","").replace("\\","").replace("<","")}),this.selection=a,this.completely=f,o instanceof r?(this.map=o,this.setup_map_callbacks()):console.error("Cannot set the map. It is not an instance of builder/Map"),u instanceof i?(this.zoom_container=u,this.setup_zoom_callbacks()):console.error("Cannot set the zoom_container. It is not an instance of builder/ZoomContainer"),this.callback_manager=new s,this.hide()}function a(){var e=this;this.map.callback_manager.set("select_metabolite_with_id.input",function(t,n){e.is_visible&&e.reload(t,n,!1),e.map.sel.selectAll(".start-reaction-target").style("visibility","hidden")}),this.map.callback_manager.set("select_metabolite.input",function(t,n,r){e.map.sel.selectAll(".start-reaction-target").style("visibility","hidden"),t==1&&e.is_visible&&r?e.reload(n,r,!1):e.hide()})}function f(){var e=this;this.zoom_container.callback_manager.set("zoom.input",function(){e.is_visible&&e.place_at_selected()})}function l(){this.toggle(!0)}function c(){this.toggle(!1)}function h(e){e===undefined?this.is_visible=!this.is_visible:this.is_visible=e,this.is_visible?(this.toggle_start_reaction_listener(!0),this.reload_at_selected(),this.map.set_status("Click on the canvas or an existing metabolite"),this.callback_manager.run("show_reaction_input")):(this.toggle_start_reaction_listener(!1),this.selection.style("display","none"),this.completely.input.blur(),this.completely.hideDropDown(),this.map.set_status(null),this.callback_manager.run("hide_reaction_input"))}function p(){this.map.deselect_text_labels();var e=this.map.select_single_node(),t=this.map.scale;if(e==null)return;var n={x:t.x(e.x),y:t.y(e.y)};this.place(n)}function d(e){var t={x:200,y:0},n=this.map.scale,r=this.map.zoom_container.window_translate,i=this.map.zoom_container.window_scale,s=Math.max(20,Math.min(this.map.width-270,i*e.x+r.x-t.x)),o=Math.max(20,Math.min(this.map.height-40,i*e.y+r.y-t.y));this.selection.style("position","absolute").style("display","block").style("left",s+"px").style("top",o+"px")}function v(){this.map.deselect_text_labels();var e=this.map.select_single_node(),t=this.map.scale;if(e==null)return;var n={x:t.x(e.x),y:t.y(e.y)};this.reload(e,n,!1)}function m(n,r,i){function x(e,t){for(var n in t)if(t[n].abbreviation==e)return!0;return!1}function T(e,t,n){return e+": "+n(t)}n===undefined&&!i&&console.error("No selected node, and not starting from scratch");var s=e.format(".3g");this.place(r),this.completely.input.blur(),this.completely.repaint();var o=[],u=this.map.cobra_model.reactions,a=this.map.reactions,f=this.map.has_flux(),l=this.map.flux;for(var c in u){var h=u[c];if(x(c,a))continue;for(var p in h.metabolites){var d=h.metabolites[p];if(!i&&n.bigg_id_compartmentalized!=p)continue;if(c in o)continue;var v,m;f?(c in l?v=l[c]*(d.coefficient<1?1:-1):v=0,m=T(c,v,s),o[c]={flux:v,string:m}):o[c]={string:c}}}var g=[],y=t.make_array(o,"reaction_abbreviation");f&&y.sort(function(e,t){return Math.abs(t.flux)-Math.abs(e.flux)}),y.forEach(function(e){g.push(e.string)});var b=20,w=this.completely,E=this,S=this.map.scale;w.options=g,g.length==1?w.setText(g[0]):w.setText(""),w.onEnter=function(){var e=this.getText();this.setText(""),y.map(function(t){if(t.string==e)if(i){var s={x:S.x.invert(r.x),y:S.y.invert(r.y)};E.map.new_reaction_from_scratch(t.reaction_abbreviation,s)}else E.map.new_reaction_for_metabolite(t.reaction_abbreviation,n.node_id)})},w.repaint(),this.completely.input.focus()}function g(t){if(t===undefined)this.start_reaction_listener=!this.start_reaction_listener;else{if(this.start_reaction_listener==t)return;this.start_reaction_listener=t}if(this.start_reaction_listener){var n=this,r=this.map,i=r.scale;r.sel.on("click.start_reaction",function(){console.log("clicked for new reaction");var t={x:i.x(i.x_size.invert(e.mouse(this)[0])),y:i.y(i.y_size.invert(e.mouse(this)[1]))};r.deselect_nodes(),r.deselect_text_labels(),n.reload(null,t,!0);var s=r.sel.selectAll(".start-reaction-target").data([12,5]);s.enter().append("circle").classed("start-reaction-target",!0).attr("r",function(e){return i.size(e)}).style("stroke-width",i.size(4)),s.style("visibility","visible").attr("transform","translate("+t.x+","+t.y+")")}),r.sel.classed("start-reaction-cursor",!0)}else this.map.sel.on("click.start_reaction",null),this.map.sel.classed("start-reaction-cursor",!1),this.map.sel.selectAll(".start-reaction-target").style("visibility","hidden")}var o=t.make_class();return o.prototype={init:u,setup_map_callbacks:a,setup_zoom_callbacks:f,show:l,hide:c,toggle:h,place_at_selected:p,place:d,reload_at_selected:v,reload:m,toggle_start_reaction_listener:g},o}),n("builder/CobraModel",["vis/utils"],function(e){function n(e,t){this.reactions=e,this.cofactors=t}var t=e.make_class();return t.prototype={init:n},t}),n("builder/Brush",["vis/utils","lib/d3"],function(e,t){function r(e,t,n,r){this.brush_sel=e.append("g").attr("id","brush-container");var i=this.brush_sel.node(),s=e.select(r).node().nextSibling;i!==s&&i.parentNode.insertBefore(i,s),this.enabled=t,this.map=n}function i(){return t.select(".brush").empty()}function s(e){e===undefined&&(e=!this.enabled),e?this.selection_brush=this.setup_selection_brush():this.brush_sel.selectAll(".brush").remove()}function o(){var e=this.brush_sel,n=t.select("#nodes").selectAll(".node"),r=this.map.width,i=this.map.height,s=[],o=this.map.scale;n.each(function(e){s.push(e.node_id)});var u=t.svg.brush().x(t.scale.identity().domain([0,r])).y(t.scale.identity().domain([0,i])).on("brush",function(){var e=t.event.target.extent();n.classed("selected",function(t){var n=o.x(t.x),r=o.y(t.y);return e[0][0]<=n&&n<e[1][0]&&e[0][1]<=r&&r<e[1][1]})}).on("brushend",function(){t.event.target.clear(),t.select(this).call(t.event.target)}),a=e.append("g").attr("class","brush").call(u);return a}var n=e.make_class();return n.prototype={init:r,toggle:s,setup_selection_brush:o},n}),n("builder/Builder",["vis/utils","lib/d3","builder/Input","builder/ZoomContainer","builder/Map","builder/CobraModel","builder/Brush","vis/CallbackManager"],function(e,t,n,r,i,s,o,u){function f(n){function s(e,t){e&&console.warn(e),this.o.map_data=t}function o(e,t){e&&console.warn(e),this.o.cobra_model=t}function u(e,t){e&&console.warn(e),this.o.css=t}function a(e,t,n){e&&console.warn(e),n==0?this.o.flux=t:n==1&&(this.o.flux2=t)}function f(e,t){e&&console.warn(e),this.o.node_data=t}var r=e.set_options(n,{margins:{top:0,right:0,bottom:0,left:0},selection:t.select("body").append("div"),selection_is_svg:!1,fillScreen:!1,enable_editing:!0,on_load:function(){},map_path:null,map:null,cobra_model_path:null,cobra_model:null,css_path:null,css:null,flux_path:null,flux:null,flux2_path:null,flux2:null,node_data:null,node_data_path:null,node_data_style:"ColorSize",show_beziers:!1,debug:!1,starting_reaction:"GLCtex",reaction_arrow_displacement:35});if(r.selection_is_svg)return console.error("Builder does not support placement within svg elements"),null;this.o=r;var i=[{file:r.map_path,value:r.map,callback:s},{file:r.cobra_model_path,value:r.cobra_model,callback:o},{file:r.css_path,value:r.css,callback:u},{file:r.flux_path,value:r.flux,callback:function(e,t){a.call(this,e,t,0)}},{file:r.flux2_path,value:r.flux2,callback:function(e,t){a.call(this,e,t,1)}},{file:r.node_data_path,value:r.node_data,callback:f}];e.load_files(this,i,l)}function l(){var a=!0,f=!1;this.callback_manager=u();var l=null;this.o.cobra_model?l=s(this.o.cobra_model.reactions,this.o.cobra_model.cofactors):console.warn("No cobra model was loaded."),e.remove_child_nodes(this.o.selection);var c=e.setup_svg(this.o.selection,this.o.selection_is_svg,this.o.margins,this.o.fill_screen),h=c.svg,p=c.height,d=c.width,v=e.setup_defs(h,this.o.css);this.zoom_container=new r(h,d,p,[.05,15]);var m=this.zoom_container.zoomed_sel,g=d,y=p,b;this.o.map_data?(this.map=i.from_data(this.o.map_data,m,v,this.zoom_container,p,d,this.o.flux,this.o.node_data,this.o.node_data_style,l),this.zoom_container.reset()):this.map=new i(m,v,this.zoom_container,p,d,this.o.flux,this.o.node_data,this.o.node_data_style,l);var w=n(this.o.selection,this.map,this.zoom_container);if(this.o.enable_editing){this.brush=new o(m,!1,this.map,".canvas-group"),this._setup_modes(this.map,this.brush,this.zoom_container);var E=this._get_keys(this.map,w,this.brush);this.map.key_manager.assigned_keys=E;var S=this._setup_menu(this.o.selection,this.map,this.zoom_container,this.map.key_manager,E),x=this._setup_status(this.o.selection,this.map)}this.map.key_manager.reaction_input=w,this.map.key_manager.update();if(this.o.map_data)this.map.draw_everything(),this.map.zoom_extent_canvas();else if(this.o.starting_reaction){var T={x:this.map.scale.x.invert(d/2),y:this.map.scale.x.invert(p/4)};this.map.new_reaction_from_scratch(this.o.starting_reaction,T),this.map.zoom_extent_nodes(300,"nodes")}else this.map.zoom_extent_canvas();this.o.enable_editing?this.zoom_mode():(this.map.behavior.turn_everything_off(),this.map.draw_everything()),t.select("#loading").style("display","none"),this.o.on_load()}function c(){this.brush.toggle(!0),this.zoom_container.toggle_zoom(!1),this.callback_manager.run("brush_mode")}function h(){this.brush.toggle(!1),this.zoom_container.toggle_zoom(!0),this.callback_manager.run("zoom_mode")}function p(t,n,r,i,s){function f(e,t){e&&console.warn(e),this.o.map_data=t,this.reload_builder()}function l(e,t){e&&console.warn(e),this.map.set_flux(t)}function c(e,t){e&&console.warn(e),this.map.set_node_data(t)}function h(e,t,n,r){var i=e.append("button").attr("class","command-button");return r!==undefined&&i.attr("id",r),p(i,t,n)}function p(e,t,n){return e.text(n).on("click",function(){t.fn.call(t.target)}),e}function d(t,n,r,i){var s=t.append("input").attr("type","file").style("display","none").on("change",function(){e.load_json(this.files[0],n,r)});return t.append("button").attr("class","command-button").text(i).on("click",function(e){s.node().click()}),function(){s.node().click()}}var o=t.append("div").attr("id","menu");h(o,s.toggle_input,"New reaction (/)"),h(o,s.save,"Save (^s)"),h(o,s.save_svg,"Export SVG (^Shift s)"),i.assigned_keys.load.fn=d(o,f,this,"Load (^o)"),i.assigned_keys.load_flux.fn=d(o,l,this,"Load flux (^f)"),d(o,c,this,"Load node data");var u=h(o,s.toggle_beziers,"Hide control points (b)","bezier-button");n.callback_manager.set("toggle_beziers.button",function(e){u.text((e?"Hide":"Show")+" control points (b)")});var a=h(o,s.brush_mode,"Enable select (v)","zoom-button");return this.callback_manager.set("zoom_mode",function(){p(a,s.brush_mode,"Enable select (v)")}).set("brush_mode",function(){p(a,s.zoom_mode,"Enable pan+zoom (z)")}),h(o,s.rotate,"Rotate (r)"),h(o,s.delete,"Delete (^del)"),h(o,s.extent_nodes,"Zoom to nodes (^0)"),h(o,s.extent_canvas,"Zoom to canvas (^1)"),h(o,s.make_primary,"Make primary metabolite (p)"),h(o,s.cycle_primary,"Cycle primary metabolite (c)"),h(o,s.direction_arrow_left,"<"),h(o,s.direction_arrow_up,"^"),h(o,s.direction_arrow_down,"v"),h(o,s.direction_arrow_right,">"),h(o,s.undo,"Undo (^z)"),h(o,s.redo,"Redo (^Shift z)"),o}function d(e,t){var n=e.append("div").attr("id","status");return t.callback_manager.set("set_status",function(e){n.text(e)}),n}function v(e,t,n){var r={};e.callback_manager.set("start_rotation",function(){r.brush=t.enabled,t.toggle(!1),r.zoom=n.zoom_on,n.toggle_zoom(!1),r.node_click=e.behavior.node_click!=null,e.behavior.toggle_node_click(!1)}),e.callback_manager.set("end_rotation",function(){t.toggle(r.brush),n.toggle_zoom(r.zoom),e.behavior.toggle_node_click(r.node_click),r={}})}function m(e,t,n){return{toggle_input:{key:191,target:t,fn:t.toggle},save:{key:83,modifiers:{control:!0},target:e,fn:e.save},save_svg:{key:83,modifiers:{control:!0,shift:!0},target:e,fn:e.save_svg},load:{key:79,modifiers:{control:!0},fn:null},load_flux:{key:70,modifiers:{control:!0},fn:null},toggle_beziers:{key:66,target:e,fn:e.toggle_beziers,ignore_with_input:!0},zoom_mode:{key:90,target:this,fn:this.zoom_mode,ignore_with_input:!0},brush_mode:{key:86,target:this,fn:this.brush_mode,ignore_with_input:!0},rotate:{key:82,target:e,fn:e.rotate_selected_nodes,ignore_with_input:!0},"delete":{key:8,modifiers:{control:!0},target:e,fn:e.delete_selected,ignore_with_input:!0},extent_nodes:{key:48,modifiers:{control:!0},target:e,fn:e.zoom_extent_nodes},extent_canvas:{key:49,modifiers:{control:!0},target:e,fn:e.zoom_extent_canvas},make_primary:{key:80,target:e,fn:e.make_selected_node_primary,ignore_with_input:!0},cycle_primary:{key:67,target:e,fn:e.cycle_primary_node,ignore_with_input:!0},direction_arrow_right:{key:39,target:e.direction_arrow,fn:e.direction_arrow.right,ignore_with_input:!0},direction_arrow_down:{key:40,target:e.direction_arrow,fn:e.direction_arrow.down,ignore_with_input:!0},direction_arrow_left:{key:37,target:e.direction_arrow,fn:e.direction_arrow.left,ignore_with_input:!0},direction_arrow_up:{key:38,target:e.direction_arrow,fn:e.direction_arrow.up,ignore_with_input:!0},undo:{key:90,modifiers:{control:!0},target:e.undo_stack,fn:e.undo_stack.undo},redo:{key:90,modifiers:{control:!0,shift:!0},target:e.undo_stack,fn:e.undo_stack.redo}}}var a=e.make_class();return a.prototype={init:f,reload_builder:l,brush_mode:c,zoom_mode:h,_setup_menu:p,_setup_status:d,_setup_modes:v,_get_keys:m},a}),n("vis/data-menu",["vis/utils","lib/d3"],function(e,t){return function(n){function o(e,t,n,r,i){n.node().addEventListener("change",function(){u(e,this.value,i,r)},!1);var s=t[0];a(t,n),u(e,s,i,r)}function u(t,n,i,s){e.load_the_file(t,n,function(e,t){if(e)return console.warn(e);r.data=t,s&&s(t)})}function a(e,t){t.selectAll(".menu-option").data(e).enter().append("option").attr("value",function(e){return e}).text(function(e){return e}),t.node().focus()}function f(){return r.data}var r=e.set_options(n,{selection:t.select("body"),getdatafiles:null,datafiles:null,update_callback:null,target:null}),i=r.selection.select(".data-menu");i.empty()&&(i=r.selection.append("div").attr("class","data-menu"));var s=i.append("form").append("select").attr("class","dropdown-menu");return r.getdatafiles?(r.datafiles&&console.warn("DataMenu: getdatafiles option overrides datafiles"),t.json(r.getdatafiles,function(e,t){return e?console.warn(e):(o(r.target,t.data,s,r.update_callback,r.selection),null)})):r.datafiles?o(r.target,r.datafiles,s,r.update_callback,r.selection):console.warn("DataMenu: No datafiles given"),{update:a}}}),n("main",["builder/Builder","builder/KeyManager","vis/data-menu"],function(e,t,n){return{Builder:e,KeyManager:t,DataMenu:n}}),t("main")});